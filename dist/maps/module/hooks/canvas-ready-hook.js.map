{"version":3,"sources":["module/hooks/canvas-ready-hook.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,GAAG,EAAE,sBAAmB;AAEjC,OAAO,EACN,YAAY,EACZ,iBAAiB,EACjB,iBAAiB,EACjB,wBAAqB;AACtB,OAAO,EAAE,SAAS,EAAE,iBAAiB,EAAE,wBAAwB,EAAE,uBAAoB;AAErF;;;;;;;GAOG;AACH,MAAM,CAAC,MAAM,4BAA4B,GAAG,UAAS,OAAO,EAAE,GAAG,IAAI;IACpE,IAAI;QACH,MAAM,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC;QACrB,sBAAsB;QACtB,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,YAAY,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,CAAC;QAClE,iBAAiB,CAAC,SAAS,EAAE,EAAE,IAAI,CAAC,CAAC;QACrC,OAAO,OAAO,CAAC,GAAG,IAAI,CAAC,CAAC;KACxB;IAAC,OAAO,KAAK,EAAE;QACf,OAAO,OAAO,CAAC,GAAG,IAAI,CAAC,CAAC;KACxB;AACF,CAAC,CAAA;AAGD;;;;;GAKG;AACH,MAAM,iBAAiB,GAAG,KAAK,EAAE,MAAM,EAAE,QAAQ,EAAE,EAAE;IACpD,GAAG,CAAC,qCAAqC,CAAC,CAAC;IAC3C,GAAG,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;IAEtB,IAAI,QAAQ,CAAC,IAAI,KAAK,MAAM,EAAE;QAC7B,iBAAiB,CAAC,MAAM,iBAAiB,CAAC,QAAQ,CAAC,CAAC,CAAC;KACrD;AACF,CAAC,CAAA;AAED,MAAM,CAAC,MAAM,eAAe,GAAG,KAAK,EAAE,MAAM,EAAE,EAAE;IAC9C,GAAG,CAAC,kBAAkB,CAAC,CAAC;IACxB,GAAG,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;IACf,KAAK,IAAI,KAAK,IAAa,SAAS,EAAE,CAAC,MAAM,EAAE,UAAU,EAAE,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,YAAY,KAAK,CAAC,EAAE;QAC3F,MAAM,UAAU,GAA2B,KAAK,CAAC,OAAO,CAAC,wBAAwB,EAAE,iBAAiB,CAAC,CAAC;QACtG,IAAI,CAAC,UAAU,EAAE,MAAM,EAAE;YACxB,SAAS;SACT;QAED,GAAG,CAAC,mCAAmC,KAAK,CAAC,EAAE,oBAAoB,UAAU,CAAC,MAAM,GAAG,CAAC,CAAC;QAEzF,IAAI,SAAS,GAAc,YAAY,CAAC,EAAE,MAAM,EAAE,UAAU,CAAC,MAAM,EAAE,OAAO,EAAE,KAAK,CAAC,EAAE,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;QAE/F,IAAI,UAAU,EAAE,QAAQ,EAAE;YACzB,SAAS,EAAE,QAAQ,EAAE,CAAC;SACtB;QAED,SAAS,EAAE,iBAAiB,EAAE,CAAC;KAC/B;IAED,KAAK,CAAC,GAAG,CAAC,gBAAgB,EAAE,iBAAiB,CAAC,CAAC;IAC/C,KAAK,CAAC,EAAE,CAAC,gBAAgB,EAAE,iBAAiB,CAAC,CAAC;AAC/C,CAAC,CAAA","file":"../../../module/hooks/canvas-ready-hook.js","sourcesContent":["import { log } from '../../main';\r\nimport { LootToken, TokenFlags } from \"../loot-token\";\r\nimport {\r\n\tgetLootToken,\r\n\thandleItemDropped,\r\n\tnormalizeDropData\r\n} from \"../mainEntry\";\r\nimport { getCanvas, PICK_UP_STIX_FLAG, PICK_UP_STIX_MODULE_NAME } from '../settings';\r\n\r\n/**\r\n * This function is called when something is dropped onto the canvas. If the\r\n * item dropped onto the canvas is a folder, it is handled here. Otherwise,\r\n * the original wrapper function is used.\r\n *\r\n * @param {fn} wrapper - The original onDrop function\r\n * @param  {...any} args - Any arguments provided with the original onDrop function\r\n */\r\nexport const CanvasPrototypeOnDropHandler = function(wrapper, ...args) {\r\n\ttry {\r\n\t\tconst [event] = args;\r\n\t\t// Get data from event\r\n\t\tconst data = JSON.parse(event.dataTransfer.getData('text/plain'));\r\n\t\tdropCanvasHandler(getCanvas(), data);\r\n\t\treturn wrapper(...args);\r\n\t} catch (error) {\r\n\t\treturn wrapper(...args);\r\n\t}\r\n}\r\n\r\n\r\n/**\r\n * Handler for the dropCanvasData Foundry hook. This is used\r\n * in Foundry 0.7.0 and above\r\n * @param canvas\r\n * @param dropData\r\n */\r\nconst dropCanvasHandler = async (canvas, dropData) => {\r\n\tlog(` dropCanvasData | called with args:`);\r\n\tlog(canvas, dropData);\r\n\r\n\tif (dropData.type === \"Item\") {\r\n\t\thandleItemDropped(await normalizeDropData(dropData));\r\n\t}\r\n}\r\n\r\nexport const canvasReadyHook = async (canvas) => {\r\n  log(` canvasReadyHook`);\r\n  log([canvas]);\r\n\tfor (let token of <Token[]>getCanvas().tokens?.placeables?.filter(p => p instanceof Token)) {\r\n\t\tconst tokenFlags: TokenFlags = <TokenFlags>token.getFlag(PICK_UP_STIX_MODULE_NAME, PICK_UP_STIX_FLAG);\r\n\t\tif (!tokenFlags?.itemId) {\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tlog(` canvasReadyHook | Found token '${token.id}' with for item '${tokenFlags.itemId}'`);\r\n\r\n\t\tlet lootToken: LootToken = getLootToken({ itemId: tokenFlags.itemId, tokenId: token.id })?.[0];\r\n\r\n\t\tif (tokenFlags?.isLocked) {\r\n\t\t\tlootToken?.drawLock();\r\n\t\t}\r\n\r\n\t\tlootToken?.activateListeners();\r\n\t}\r\n\r\n\tHooks.off('dropCanvasData', dropCanvasHandler);\r\n\tHooks.on('dropCanvasData', dropCanvasHandler);\r\n}\r\n"]}