{"version":3,"sources":["module/hooks/pre-update-token-hook.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,GAAG,EAAE,sBAAmB;AAEjC,OAAO,EAAE,WAAW,EAAgB,iBAAiB,EAAE,iBAAiB,EAAE,wBAAqB;AAC/F,OAAO,EAAE,OAAO,EAAE,uBAAoB;AACtC,OAAO,EAAE,cAAc,EAAE,oBAAiB;AAE1C;;;;;;;;;;GAUG;AACH,MAAM,CAAC,MAAM,kBAAkB,GAAG,KAAK,EAAE,KAAK,EAAE,SAAS,EAAE,OAAO,EAAE,OAAO,EAAE,MAAM,EAAoB,EAAE;IACvG,GAAG,CAAC,sBAAsB,CAAC,CAAC;IAC5B,GAAG,CAAC,CAAC,KAAK,EAAE,SAAS,EAAE,OAAO,EAAE,OAAO,EAAE,MAAM,CAAC,CAAC,CAAC;IAElD,MAAM,UAAU,GAAe,WAAW,CAAC,SAAS,EAAE,iCAAiC,CAAC,CAAC;IAEzF,6GAA6G;IAC7G,IAAI,CAAC,OAAO,CAAC,CAAC,KAAK,SAAS,IAAI,OAAO,CAAC,CAAC,KAAK,SAAS,CAAC,IAAI,CAAC,UAAU,EAAE,MAAM,EAAE;QAC/E,OAAO,IAAI,CAAC;KACb;IAED,iDAAiD;IACjD,IAAI,MAAM,GAAG,cAAc,CAAC,EAAE,CAAC,EAAE,OAAO,CAAC,CAAC,IAAI,SAAS,CAAC,CAAC,EAAE,CAAC,EAAE,OAAO,CAAC,CAAC,IAAI,SAAS,CAAC,CAAC,EAAE,CAAC,CAAC;IAE1F,qCAAqC;IACrC,MAAM,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,EAAE,KAAK,SAAS,CAAC,GAAG,CAAC,CAAC;IAEtD,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE;QACrB,4GAA4G;QAC5G,EAAE,CAAC,aAAa,EAAE,KAAK,CAAC,mDAAmD,CAAC,CAAC;QAC7E,OAAO,KAAK,CAAC;KACd;SAAM,IAAI,MAAM,CAAC,MAAM,KAAK,CAAC,EAAE;QAC9B,4DAA4D;QAC5D,OAAO,IAAI,CAAC;KACb;IAED,MAAM,IAAI,GAAS,OAAO,EAAE,CAAC,KAAK,EAAE,GAAG,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;IAE3D,MAAM,eAAe,GAAG,MAAM,iBAAiB,CAC7C,MAAM,iBAAiB,CAAC;QACtB,CAAC,EAAE,OAAO,CAAC,CAAC,IAAI,SAAS,CAAC,CAAC;QAC3B,CAAC,EAAE,OAAO,CAAC,CAAC,IAAI,SAAS,CAAC,CAAC;QAC3B,IAAI,EAAE,IAAI,CAAC,IAAI,CAAC,IAAI;QACpB,EAAE,EAAU,IAAI,CAAC,EAAE;KACpB,CAAC,CACH,CAAC;IAEF,IAAI,eAAe,EAAE;QACnB,MAAM,WAAW,CAAC,SAAS,CAAC,GAAG,EAAE,KAAK,CAAC,EAAE,CAAC,CAAC;KAC5C;IAED,OAAO,KAAK,CAAC;AACf,CAAC,CAAC","file":"../../../module/hooks/pre-update-token-hook.js","sourcesContent":["import { log } from '../../main';\nimport { TokenFlags } from '../loot-token';\nimport { deleteToken, getLootToken, handleItemDropped, normalizeDropData } from '../mainEntry';\nimport { getGame } from '../settings';\nimport { collidedTokens } from '../utils';\n\n/**\n * One thing we want to check before a token is updated would be if the x or y positions are changing. If they are\n * then we could be moving the token onto another token and in that case we want to check if it's a valid drop target\n *\n * @param scene\n * @param tokenData\n * @param updates\n * @param options\n * @param userId\n * @returns True if the token should update should proces, false if it should not\n */\nexport const preUpdateTokenHook = async (scene, tokenData, updates, options, userId): Promise<boolean> => {\n  log(` preUpdateTokenHook:`);\n  log([scene, tokenData, updates, options, userId]);\n\n  const tokenFlags: TokenFlags = getProperty(tokenData, 'flags.pick-up-stix.pick-up-stix');\n\n  // if the x or y positions are not being updated or the token doesn't have an itemId flag, then we don't care\n  if ((updates.y === undefined && updates.x === undefined) || !tokenFlags?.itemId) {\n    return true;\n  }\n\n  // get any tokens that are under the new position\n  let tokens = collidedTokens({ x: updates.x ?? tokenData.x, y: updates.y ?? tokenData.y });\n\n  // filter out the token being updated\n  tokens = tokens.filter((t) => t.id !== tokenData._id);\n\n  if (tokens.length > 1) {\n    // if we are dropping it onto more than one token, then we can't know which to drop it onto, notify the user\n    ui.notifications?.error('You can drop an item onto one and only one target');\n    return false;\n  } else if (tokens.length === 0) {\n    // if we're not dropping it onto a token, then we don't care\n    return true;\n  }\n\n  const item = <Item>getGame().items?.get(tokenFlags.itemId);\n\n  const itemDropSuccess = await handleItemDropped(\n    await normalizeDropData({\n      x: updates.x ?? tokenData.x,\n      y: updates.y ?? tokenData.y,\n      type: item.data.type,\n      id: <string>item.id,\n    }),\n  );\n\n  if (itemDropSuccess) {\n    await deleteToken(tokenData._id, scene.id);\n  }\n\n  return false;\n};\n"]}