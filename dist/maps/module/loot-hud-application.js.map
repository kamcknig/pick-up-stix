{"version":3,"sources":["module/loot-hud-application.ts"],"names":[],"mappings":"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","file":"../../module/loot-hud-application.js","sourcesContent":["import { getLootToken } from \"./mainEntry\";\r\nimport { LootEmitLightConfigApplication } from \"./loot-emit-light-config-application\";\r\nimport { error, log } from '../main';\r\nimport { getGame, PICK_UP_STIX_FLAG, PICK_UP_STIX_ITEM_ID_FLAG, PICK_UP_STIX_MODULE_NAME, SettingKeys } from \"./settings\";\r\n\r\nexport class LootHud extends BasePlaceableHUD<Token> {\r\n\r\n  static get defaultOptions() {\r\n    return mergeObject(super.defaultOptions, {\r\n      height: <string | null | undefined>'auto',\r\n      minimizable: false,\r\n      id: 'loot-hud',\r\n      resizable: false,\r\n      template: `/modules/${PICK_UP_STIX_MODULE_NAME}/templates/loot-hud.html`,\r\n      classes: ['pick-up-stix', 'loot-hud'].concat(super.defaultOptions.classes)\r\n    });\r\n  }\r\n\r\n  private get itemId(): string {\r\n    return <string>this.object?.document.getFlag(PICK_UP_STIX_MODULE_NAME, PICK_UP_STIX_ITEM_ID_FLAG);\r\n  }\r\n\r\n  constructor() {\r\n    super({});\r\n    log(` LootHud ${this.appId} | constructor called with args`);\r\n    log(LootHud.defaultOptions);\r\n  }\r\n\r\n  activateListeners(html) {\r\n    log(` LootHud ${this.appId} | activateListeners called with args`);\r\n    log([html]);\r\n    super.activateListeners(html);\r\n    html.find(\".config\").click(this.onTokenConfig);\r\n    html.find(\".locked\").click(this._onToggleItemLocked);\r\n    html.find(\".emit-light\").click(this.onConfigureLightEmission);\r\n    html.find(\".visibility-perceive-input\").on('change', this.onPerceiveValueChanged);\r\n  }\r\n\r\n  private onPerceiveValueChanged = (e) => {\r\n    log(` LootHudApplication ${this.appId} | onPerceivedValueChanged`);\r\n    const val = +e.currentTarget.value;\r\n    log([val]);\r\n\r\n    if (val === undefined || val === null || isNaN(val)) {\r\n      ui.notifications?.error(`Invalid value '${val}'`);\r\n      return;\r\n    }\r\n\r\n    if (val < 0) {\r\n      ui.notifications?.error(`Minimum perceived value must be 0`);\r\n      return;\r\n    }\r\n\r\n    this.object?.document.update({\r\n      flags: {\r\n        'pick-up-stix': {\r\n          'pick-up-stix': {\r\n            minPerceiveValue: val\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private onConfigureLightEmission = async (event) => {\r\n    log(` LootHud ${this.appId} | _onConfigureLightEmission`);\r\n    const f = new LootEmitLightConfigApplication(this.object, {}).render(true);\r\n  }\r\n\r\n  private _onToggleItemLocked = async (event) => {\r\n    log(` LootHud ${this.appId} | _onToggleItemLocked`);\r\n    const lootToken = getLootToken({ itemId: this.itemId, tokenId: <string>this.object?.document.id })?.[0];\r\n\r\n    if (!lootToken) {\r\n      error(`No valid LootToken instance found for token '${<string>this.object?.document.id}' and Item id '${this.itemId}'`);\r\n      return;\r\n    }\r\n\r\n    await lootToken.toggleLocked();\r\n    this.render();\r\n  }\r\n\r\n  private onTokenConfig = async (event) => {\r\n    log(` LootHud ${this.appId} | _onTokenConfig`);\r\n\r\n    const item = <Item>getGame().items?.get(this.itemId);\r\n    item.sheet?.render(true, { renderData: { sourceToken: this.object?.document.data._id }});\r\n  }\r\n\r\n  getData(options?: Application.RenderOptions) {\r\n    log(` LootHud ${this.appId} | getData`);\r\n    const lootData = getLootToken({ itemId: this.itemId, tokenId: <string>this.object?.document.id })?.[0];;\r\n    if (!lootData) {\r\n      //@ts-ignore\r\n      error(`No valid LootToken instance found for token '${this.object?.document.id}' on scene '${this.object?.document.scene?.id}'`);\r\n    }\r\n\r\n    const data:any = {\r\n      canConfigure: getGame().user?.can(\"TOKEN_CONFIGURE\"),\r\n      visibilityClass: this.object?.document.data.hidden ? 'active' : '',\r\n      //@ts-ignore\r\n      lockedClass: <string>this.object?.document.data.locked ? 'active' : '',\r\n      showPerceiveInput: getGame().settings.get(PICK_UP_STIX_MODULE_NAME, SettingKeys.enableLootTokenPerceiveReveal),\r\n      minPerceiveValue: <number>(<any>this.object?.document.getFlag(PICK_UP_STIX_MODULE_NAME, PICK_UP_STIX_FLAG)).minPerceiveValue ?? getGame().settings.get(PICK_UP_STIX_MODULE_NAME, SettingKeys.defaultMinimumPerceiveValue),\r\n      id: this.id,\r\n      classes: this.options.classes.join(\" \"),\r\n      appId: this.appId,\r\n      isGM: getGame().user?.isGM,\r\n      icons: CONFIG.controlIcons\r\n    };\r\n\r\n    log([data]);\r\n    return data;\r\n  }\r\n}\r\n"]}