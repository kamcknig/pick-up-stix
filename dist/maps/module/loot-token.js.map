{"version":3,"sources":["module/loot-token.ts"],"names":[],"mappings":"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","file":"../../module/loot-token.js","sourcesContent":["import { error, log } from '../main';\nimport { getPriceDataPath, getQuantityDataPath, getWeightDataPath } from './utils';\nimport { getValidControlledTokens, lootItem, updateItem, updateToken } from './mainEntry';\nimport { ItemType } from './models';\nimport {\n  getCanvas,\n  getGame,\n  PICK_UP_STIX_FLAG,\n  PICK_UP_STIX_MODULE_NAME,\n  PICK_UP_STIX_TOKEN_ID_FLAG,\n} from './settings';\n\n/**\n * These are the flags stored on a Token instance.\n */\nexport interface TokenFlags {\n  /**\n   * The Item ID of the entity that this token represents.\n   */\n  itemId?: string;\n  isOpen?: boolean;\n  isLocked?: boolean;\n  minPerceiveValue: number;\n}\n\nexport interface ItemFlags {\n  itemType: ItemType;\n\n  tokenData: TokenData;\n\n  container?: ContainerData;\n}\n\nexport interface OwnedItemFlags {\n  owner: string;\n}\n\nexport interface ContainerData {\n  canClose?: boolean;\n  soundOpenPath: string;\n  soundClosePath: string;\n  imageClosePath: string;\n  imageOpenPath: string;\n  loot: ContainerLoot;\n  currency?: any;\n  description?: string;\n}\n\n/**\n * Each key should be the Item.type and the value will be an Array whose elements are Item.data\n */\nexport interface ContainerLoot {\n  [key: string]: ItemData[];\n}\n\n/**\n * This represents the Token data that will represent the loot Item. It's used\n * when creating the token to represent its physical properties\n */\nexport interface TokenData {\n  name: string;\n  img: string;\n  width: number;\n  height: number;\n  disposition: number;\n  x?: number;\n  y?: number;\n  id?: string;\n  flags?: {\n    'pick-up-stix': {\n      'pick-up-stix': TokenFlags;\n    };\n  };\n}\n\nexport interface ItemData {\n  data: any;\n  effects: any[];\n  flags: {\n    'pick-up-stix': {\n      'pick-up-stix': ItemFlags;\n    };\n  };\n  folder?: string;\n  img: string;\n  name: string;\n  permission: {\n    default: number;\n    [userId: string]: number;\n  };\n  sort: number;\n  type: string;\n  _id: string;\n  [key: string]: any;\n}\n\nexport class LootToken {\n  private _sceneId: string;\n\n  get itemFlags(): ItemFlags {\n    return <ItemFlags>this.item.getFlag(PICK_UP_STIX_MODULE_NAME, PICK_UP_STIX_FLAG);\n  }\n\n  get isOpen(): boolean {\n    return this.tokenData?.flags?.[PICK_UP_STIX_MODULE_NAME]?.[PICK_UP_STIX_FLAG]?.isOpen ?? false;\n  }\n\n  get soundClosePath(): string {\n    return <string>this.itemFlags?.container?.soundClosePath;\n  }\n\n  get soundOpenPath(): string {\n    return <string>this.itemFlags?.container?.soundOpenPath;\n  }\n\n  get isLocked(): boolean {\n    return this.tokenData?.flags?.['pick-up-stix']?.['pick-up-stix']?.isLocked ?? false;\n  }\n\n  get itemType(): ItemType {\n    return this.itemFlags?.itemType;\n  }\n\n  get canClose(): boolean {\n    return <boolean>this.itemFlags?.container?.canClose;\n  }\n\n  get item(): Item {\n    return <Item>getGame().items?.get(this.itemId);\n  }\n\n  /**\n   * The Scene ID that the Token this LootToken instance represents belongs to\n   */\n  get sceneId(): string {\n    return this._sceneId;\n  }\n\n  get token(): Token {\n    return <Token>getCanvas().tokens?.placeables.find((p) => p.id === this.tokenId) ?? null;\n  }\n\n  get tokenData(): any {\n    return getGame().scenes?.get(this._sceneId)?.getEmbeddedEntity('Token', this._tokenId);\n  }\n\n  /**\n   * The Token ID this LootToken instance represents.\n   */\n  get tokenId(): string {\n    return this._tokenId;\n  }\n\n  get itemId(): string {\n    return this._itemId;\n  }\n\n  constructor(private _tokenId: string, private _itemId: string) {\n    log('pick-up-stix | LootToken | constructor:');\n    log([this._tokenId, this._itemId]);\n    for (const el of <Scenes>getGame().scenes) {\n      const scene = el as unknown as Scene;\n      const token = scene.getEmbeddedEntity('Token', this._tokenId);\n      if (token) {\n        this._sceneId = <string>scene.id;\n        log(` LootToken | constructor | scene id set to '${this._sceneId}'`);\n      }\n    }\n  }\n\n  public activateListeners = (): void => {\n    if (!getCanvas().tokens?.placeables.find((p) => p.id === this.tokenData._id)) {\n      return;\n    }\n\n    log(` LootToken | activateListeners`);\n\n    const token = <Token>this.token;\n\n    this.deactivateListeners();\n\n    Hooks.on('updateToken', this.updateTokenHook);\n    //@ts-ignore\n    token.activateListeners = this.setupMouseManager;\n  };\n\n  public deactivateListeners = (): void => {\n    log(` LootToken | deactivateListeners`);\n    Hooks.off('updateToken', this.updateTokenHook);\n\n    const token = this.token;\n    (token?.mouseInteractionManager as any)?._deactivateDragEvents();\n  };\n\n  private updateTokenHook = async (scene, tokenData, data, options, userId) => {\n    if (this.tokenId !== tokenData._id || this.sceneId !== scene.id) {\n      return;\n    }\n\n    const token = this.token;\n\n    log(` LootToken | updateTokenHook`);\n    log([scene, tokenData, data, options, userId]);\n\n    if (tokenData.flags?.['pick-up-stix']?.['pick-up-stix']?.isLocked) {\n      log(` LootToken | updateTokenHook | token is locked, draw lock icon`);\n      this.drawLock();\n    } else {\n      const lock = token?.getChildByName('pick-up-stix-lock');\n\n      if (lock) {\n        log(` LootToken | updateTokenHook | token is not locked, but found lock icon, remove it`);\n        token.removeChild(lock);\n        lock.destroy();\n      }\n    }\n  };\n\n  public drawLock = async () => {\n    log(` LootToken | drawLockIcon`);\n\n    if (!getGame().user?.isGM) {\n      log(` LootToken | drawLockIcon | user is not GM, not drawing lock`);\n      return;\n    }\n\n    const token = this.token;\n    const lock = token?.getChildByName('pick-up-stix-lock');\n    if (lock) {\n      log(` LootToken | drawLock | found previous lock icon, removing it`);\n      token.removeChild(lock);\n      lock.destroy();\n    }\n\n    const tex = await loadTexture('icons/svg/padlock.svg');\n    const icon = token?.addChild(new PIXI.Sprite(tex));\n    if (icon) {\n      icon.name = 'pick-up-stix-lock';\n      icon.width = icon.height = 40;\n      icon.alpha = 0.5;\n      icon.position.set(token.width * 0.5 - icon.width * 0.5, token.height * 0.5 - icon.height * 0.5);\n    }\n  };\n\n  toggleLocked = async () => {\n    log(` LootToken | toggleLocked`);\n    const locked = this.tokenData?.flags?.['pick-up-stix']?.['pick-up-stix']?.isLocked ?? false;\n    updateToken(this.sceneId, {\n      _id: this.tokenId,\n      flags: {\n        'pick-up-stix': {\n          'pick-up-stix': {\n            isLocked: !locked,\n          },\n        },\n      },\n    });\n  };\n\n  toggleOpened = async (tokens: Token[] = [], renderSheet = true) => {\n    log(' LootToken | toggleOpened');\n    const itemFlags = this.itemFlags;\n\n    const openTmp = !this.isOpen;\n\n    updateToken(this.sceneId, {\n      _id: this.tokenId,\n      img: openTmp ? itemFlags.container?.imageOpenPath : itemFlags.container?.imageClosePath,\n      flags: {\n        'pick-up-stix': {\n          'pick-up-stix': {\n            isOpen: openTmp,\n          },\n        },\n      },\n    });\n\n    const audioPath = (openTmp && itemFlags.container?.soundOpenPath) ?? (!open && itemFlags.container?.soundClosePath);\n\n    if (audioPath) {\n      const a = new Audio(audioPath);\n      try {\n        a.play();\n      } catch (e) {\n        // it's ok to error here\n        error(e);\n      }\n    }\n    if (renderSheet && openTmp) {\n      this.openConfigSheet(tokens);\n    }\n  };\n\n  addItem = async (itemData: any): Promise<void> => {\n    if (this.itemType !== ItemType.CONTAINER) {\n      return;\n    }\n\n    log('pick-up-stix | LootToken | addItem');\n\n    const itemFlags = <ItemFlags>duplicate(this.itemFlags);\n\n    const existingItem = Object.values(itemFlags?.container?.loot?.[itemData?.type] ?? [])?.find(\n      (i) =>\n        i.name?.toLowerCase() === itemData.name?.toLowerCase() &&\n        i.img === itemData.img &&\n        i.data?.description?.value?.toLowerCase() === itemData.data?.description?.value?.toLowerCase() &&\n        getProperty(i.data, getPriceDataPath()) === getProperty(itemData.data, getPriceDataPath()) &&\n        getProperty(i.data, getWeightDataPath()) === getProperty(itemData.data, getWeightDataPath()),\n    );\n\n    if (existingItem) {\n      log(` LootToken | addItem | found existing item for item '${itemData._id}`);\n      const quantityDataPath = getQuantityDataPath();\n      if (!getProperty(existingItem.data, quantityDataPath)) {\n        setProperty(existingItem.data, quantityDataPath, 1);\n      } else {\n        setProperty(existingItem.data, quantityDataPath, +getProperty(existingItem.data, quantityDataPath) + 1);\n      }\n    } else {\n      const containerData: ContainerData = <ContainerData>itemFlags.container;\n      if (!containerData?.loot) {\n        containerData.loot = {};\n      }\n      if (!containerData?.loot[itemData.type]) {\n        containerData.loot[itemData.type] = [];\n      }\n      containerData.loot[itemData.type].push(itemData);\n      itemFlags.container = containerData;\n    }\n\n    updateItem(this.itemId, {\n      flags: {\n        'pick-up-stix': {\n          'pick-up-stix': itemFlags,\n        },\n      },\n    });\n  };\n\n  collect = async (token: Token) => {\n    if (this.itemType !== ItemType.ITEM) {\n      return;\n    }\n    //@ts-ignore\n    lootItem({ looterTokenId: token.id, itemData: this.item.data, lootTokenTokenId: this.tokenId, takeAll: true });\n  };\n\n  openConfigSheet = async (tokens: Token[] = [], options: any = {}): Promise<void> => {\n    log(' LootToken | openConfigSheet:');\n    log([tokens, options]);\n\n    const closeContainerConfigApplicationHook = async (app, html) => {\n      log(` LootToken | openConfigSheet | closeContainerConfigApplicationHook`);\n      log([app, html]);\n\n      if (app.appId !== appId) {\n        return;\n      }\n\n      Hooks.off('closeContainerConfigApplication', closeContainerConfigApplicationHook);\n\n      if (this.isOpen) {\n        await this.toggleOpened();\n      }\n    };\n\n    for (const itemTmp of <Items>getGame().items) {\n      const i: Item = itemTmp as Item;\n\n      const flags: ItemFlags = <ItemFlags>i.getFlag(PICK_UP_STIX_MODULE_NAME, PICK_UP_STIX_FLAG);\n\n      if (this.itemId === i.id || flags === undefined) {\n        continue;\n      }\n\n      for (const app of Object.values((i as any).apps)) {\n        (app as any).close();\n      }\n    }\n\n    Hooks.once('closeContainerConfigApplication', closeContainerConfigApplicationHook);\n    const item = <Item>this.item;\n    const appId = <string>(\n      (<any>item.sheet?.render(!item.sheet?.rendered, { renderData: { tokens, sourceToken: <string>this.tokenId } }))\n        .appId\n    );\n  };\n\n  /**************************\n   * MOUSE HANDLER METHODS\n   **************************/\n\n  private setupMouseManager = (): MouseInteractionManager<PIXI.Container> | null => {\n    log(` setupMouseManager`);\n\n    const token = <Token>this.token;\n\n    if (!token) {\n      throw new Error(\"Can't create MouseInteractionManager without a Token\");\n    }\n\n    const permissions: MouseInteractionManager['permissions'] = {\n      clickLeft: () => true,\n      clickLeft2: () => <boolean>getGame().user?.isGM,\n      clickRight: () => <boolean>getGame().user?.isGM,\n      clickRight2: () => <boolean>getGame().user?.isGM,\n      dragLeftStart: () => <boolean>getGame().user?.isGM,\n      hoverIn: () => true,\n      hoverOut: () => true,\n    };\n\n    // Define callback functions for each workflow step\n    const callbacks = {\n      clickLeft: this.handleClickLeft,\n      clickLeft2: this.handleClickLeft2,\n      clickRight: this.handleClickRight,\n      clickRight2: this.handleClickRight2,\n      //@ts-ignore\n      dragLeftStart: (e) => {\n        clearTimeout(this._clickTimeout);\n        //@ts-ignore\n        token._onDragLeftStart(e);\n      },\n      //@ts-ignore\n      dragLeftMove: token._onDragLeftMove,\n      //@ts-ignore\n      dragLeftDrop: token._onDragLeftDrop,\n      //@ts-ignore\n      dragLeftCancel: token._onDragLeftCancel,\n      //@ts-ignore\n      hoverIn: () => token._onHoverIn,\n      //@ts-ignore\n      hoverOut: () => token._onHoverOut,\n    };\n\n    // Define options\n    const options = {\n      target: token.controlIcon ? 'controlIcon' : null,\n    };\n\n    // Create the interaction manager\n    if (token) {\n      return new MouseInteractionManager(\n        token,\n        <PIXI.Container>getCanvas().stage,\n        permissions,\n        callbacks,\n        options,\n      ).activate();\n    } else {\n      return null;\n    }\n  };\n\n  private handleClickLeft = (event) => {\n    const token = this.token;\n\n    if (!token.isVisible) {\n      log(` LootToken | handleClickLeft | token is hidden`);\n      // if the loot token is hidden, pass the click on\n      // to the token's normal left click method for Foundry\n      // to handle\n      //@ts-ignore\n      token._onClickLeft(event);\n      return;\n    }\n\n    const allControlled = getCanvas().tokens?.controlled;\n    const tokens = getValidControlledTokens(token);\n\n    // checking for double click, the double click handler clears this timeout\n    this._clickTimeout = setTimeout(this.finalizeClickLeft, 250, event, allControlled, tokens);\n  };\n\n  private finalizeClickLeft = async (event, allControlled: Token[], tokens: Token[]) => {\n    log(' LootToken | finalizeClickLeft');\n    log([event, allControlled, tokens]);\n\n    const token = this.token;\n\n    // if it's locked then it can't be opened\n    if (this.isLocked) {\n      log(` LootToken | finalizeClickLeft | item is locked`);\n      const audio = new Audio(CONFIG.sounds.lock);\n      audio.play();\n      return;\n    }\n\n    if (!tokens.length) {\n      if (!getGame().user?.isGM) {\n        ui.notifications?.error(\n          `Please ensure you have at least one token controlled that is close enough to the loot token.`,\n        );\n      } else {\n        //@ts-ignore\n        token._onClickLeft(event);\n      }\n      return;\n    }\n    //@ts-ignore\n    token._onClickLeft(event);\n\n    for (const t of allControlled) {\n      t.control({ releaseOthers: false });\n    }\n\n    if (this.itemFlags.itemType === ItemType.ITEM) {\n      log(` LootToken | finalizeClickLeft | token is an ItemType.ITEM`);\n\n      this.collect(tokens[0]);\n      return;\n    }\n\n    if (this.itemFlags.itemType === ItemType.CONTAINER) {\n      log(` LootToken | finalizeClickLeft | item is a container`);\n\n      if (this.isOpen) {\n        this.openConfigSheet(tokens);\n      } else {\n        this.toggleOpened(tokens);\n      }\n\n      return;\n    }\n  };\n\n  private _clickTimeout;\n  private handleClickRight = () => {\n    log(` LootToken | handleClickRight`);\n    clearTimeout(this._clickTimeout);\n\n    getCanvas().tokens?.hud.clear();\n\n    const token = this.token;\n    //@ts-ignore\n    const hud = getCanvas().hud.pickUpStixLootHud;\n    if (hud) {\n      token?.control({ releaseOthers: true });\n      if (hud.object === token) {\n        hud.clear();\n      } else hud.bind(token);\n    }\n  };\n\n  private handleClickLeft2 = async (event) => {\n    log(' LootToken | handleClickLeft2');\n    clearTimeout(this._clickTimeout);\n\n    this.openConfigSheet();\n  };\n\n  private handleClickRight2 = async (event) => {\n    log(' LootToken | handleClickRight2');\n    clearTimeout(this._clickTimeout);\n    const i = getGame().items?.contents.find((item) => {\n      return item.getFlag(PICK_UP_STIX_MODULE_NAME, PICK_UP_STIX_TOKEN_ID_FLAG) === this.tokenId;\n    });\n\n    if (i) {\n      ui.notifications?.error(\n        `Another character is interacting with this item. Please wait your turn or ask them to close their loot sheet.`,\n      );\n      return;\n    }\n    this.openConfigSheet([], { configureOnly: true });\n  };\n}\n"]}