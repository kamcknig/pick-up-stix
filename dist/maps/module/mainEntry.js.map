{"version":3,"sources":["module/mainEntry.ts"],"names":[],"mappings":"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","file":"../../module/mainEntry.js","sourcesContent":["\r\nimport { log } from '../main';\r\nimport {\r\n\tcollidedTokens,\r\n\tgetActorCurrencyPath,\r\n\tgetCurrencyTypes,\r\n\tgetPriceDataPath,\r\n\tgetQuantityDataPath,\r\n\tgetWeightDataPath,\r\n\tinitiateRecord\r\n} from './utils';\r\nimport {\r\n\tContainerData,\r\n\tContainerLoot,\r\n\tItemData,\r\n\tItemFlags,\r\n\tLootToken,\r\n\tTokenData,\r\n\tTokenFlags\r\n} from \"./loot-token\";\r\nimport {\r\n\tDropData,\r\n\tItemType,\r\n\tPickUpStixHooks,\r\n\tSocketMessage,\r\n\tSocketMessageType\r\n} from \"./models\";\r\nimport { getCanvas, getGame, gmActionTimeout, PICK_UP_STIX_FLAG, PICK_UP_STIX_MODULE_NAME, PICK_UP_STIX_SOCKET, SettingKeys } from \"./settings\";\r\n\r\nexport const lootTokens: LootToken[] = [];\r\nwindow['lootTokens'] = lootTokens;\r\n\r\nexport type CreateLootToken = {\r\n\t(tokenData: string, itemData: string, notify?: boolean): Promise<LootToken>;\r\n\t(tokenData: TokenData, itemData: string, notify?: boolean): Promise<LootToken>;\r\n\t(tokenData: TokenData, itemData: ItemData, notify?: boolean): Promise<LootToken>;\r\n}\r\n\r\nexport const getLootToken = (options: { itemId?: string, tokenId?: string, sceneId?: string }): LootToken[] => {\r\n\tif (!options.itemId && !options.tokenId && !options.sceneId) {\r\n\t\tthrow new Error('Must provide itemId, tokenId or sceneId');\r\n\t}\r\n\r\n\treturn lootTokens.filter(lt => {\r\n\t\tif (options.itemId && options.itemId !== lt.itemId) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\tif (options.sceneId && options.sceneId !== lt.sceneId) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\tif (options.tokenId && options.tokenId !== lt.tokenId) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t});\r\n};\r\n\r\n/**\r\n * @param data Either a Token or a Token ID\r\n */\r\nexport const getValidControlledTokens = (data: string | Token): Token[] => {\r\n\tlog(` getValidControlledTokens:`);\r\n\tlog([data]);\r\n\r\n\tlet token: Token;\r\n\r\n\tif (typeof data === 'string') {\r\n\t\ttoken = <Token>getCanvas().tokens?.placeables.find(p => p.id === data);\r\n\t}\r\n\telse {\r\n\t\ttoken = data;\r\n\t}\r\n\r\n\tif (!token) {\r\n\t\tlog(` getValidControlledTokens | no token provided so returning nothing`);\r\n\t\treturn [];\r\n\t}\r\n\r\n\tlog(` getValidControlledTokens | Looking for tokens near '${token.id}' '${token.name}`);\r\n\r\n\tlog(` getValidControlledTokens | looping through currently controlled tokens`);\r\n\tlog([getCanvas().tokens?.controlled]);\r\n\r\n\tconst controlled = <Token[]>getCanvas().tokens?.controlled.filter(t => {\r\n\t\tif (!t.actor) {\r\n\t\t\tlog(` getValidControlledTokens | token '${t.id}' '${t.name}' has no actor, skipping`);\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn (\r\n\t\t\tt.x + t.w > token.x - <number>getCanvas().grid?.size &&\r\n\t\t\tt.x < token.x + token.w + <number>getCanvas().grid?.size &&\r\n\t\t\tt.y + t.h > token.y - <number>getCanvas().grid?.size &&\r\n\t\t\tt.y < token.y + token.h + <number>getCanvas().grid?.size\r\n\t\t);\r\n\t});\r\n\r\n\tlog(` getValidControlledTokens | controlled tokens within range`);\r\n\tlog([controlled]);\r\n\treturn controlled;\r\n}\r\n\r\nexport const normalizeDropData = async (data: Partial<DropData>): Promise<DropData> => {\r\n\tlog('pick-up-stix | normalizeDropData called with args:');\r\n\tlog([data]);\r\n\r\n\tif (data.actorId) {\r\n\t\tdata.actor = data.tokenId ? getGame().actors?.tokens[data.tokenId] : getGame().actors?.get(data.actorId);\r\n\t}\r\n\r\n\tconst pack: any = data.pack ? getGame().packs.get(data.pack) : null;\r\n\tconst id: string = <string>data.id;\r\n\tdata.data = data.actor\r\n\t\t? data.data\r\n\t\t: (\r\n\t\t\tpack\r\n\t\t\t\t? (await pack.getEntity(id))?.data\r\n\t\t\t\t: getGame().items?.get(id)?.data\r\n\t\t);\r\n\r\n\t// if it's not a container, then we can assume it's an item. Create the item token\r\n\tconst hg = <number>getCanvas().dimensions?.size * .5;\r\n\tconst { x, y } = <any>getCanvas().grid?.getSnappedPosition(<number>data.x - hg, <number>data.y - hg, 1);\r\n\tdata.gridX = x;\r\n\tdata.gridY = y;\r\n\r\n\treturn data as DropData;\r\n}\r\n\r\n/**\r\n * Handles data dropped onto the getCanvas().\r\n *\r\n * @param dropData\r\n */\r\nexport async function handleItemDropped(dropData: DropData): Promise<boolean> {\r\n\tlog(` handleItemDropped | called with args:`);\r\n\tlog(dropData);\r\n\r\n\t// The data here should already be normalized, meaning that if we were able to determine the actor reference,\r\n\t// it should exist here. So if we have an actor ID but no actor, that means we weren't able to figure out\r\n\t// which actor this item might have come from.\r\n\tif (dropData.actorId && !dropData.actor) {\r\n\t\tui.notifications?.error(`Please ensure you are only controlling the token (and only the one token) for the character you're working with.`);\r\n\t\treturn false;\r\n\t}\r\n\r\n\t// loop through placeables on the map and see if it's being dropped onto a token\r\n\tconst targetTokens = collidedTokens({ x: dropData.x, y: dropData.y });\r\n\r\n\tif (targetTokens.length > 1) {\r\n\t\tui.notifications?.error('You can drop an item onto one and only one target');\r\n\t\treturn false;\r\n\t}\r\n\r\n\tconst targetToken = targetTokens?.[0];\r\n\r\n\treturn targetToken\r\n\t\t? dropItemOnToken({ targetTokenId: targetToken.id, dropData })\r\n\t\t: dropItemOnCanvas({ dropData });\r\n}\r\n\r\nconst dropItemOnCanvas = async ({ dropData }) => {\r\n\tlog(` dropItemOnCanvas:`);\r\n\tlog([dropData]);\r\n\r\n\tlet itemData: any = duplicate(dropData.data);\r\n\tlet lootTokens: LootToken[] = getLootToken({ itemId: itemData._id });\r\n\r\n\tlet tokenData: TokenData = mergeObject(\r\n\t\t{\r\n\t\t\tname: itemData.name,\r\n\t\t\tdisposition: 0,\r\n\t\t\timg: itemData.img,\r\n\t\t\twidth: 1,\r\n\t\t\theight: 1,\r\n\t\t\tx: dropData.gridX,\r\n\t\t\ty: dropData.gridY,\r\n\t\t\tflags: {\r\n\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\tisOpen: false\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\t{\r\n\t\t\t...itemData.flags?.[PICK_UP_STIX_MODULE_NAME]?.[PICK_UP_STIX_FLAG]?.tokenData ?? {}\r\n\t\t}\r\n\t);\r\n\r\n\tmergeObject(itemData, {\r\n\t\tflags: {\r\n\t\t\t'pick-up-stix': {\r\n\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\ttokenData: {\r\n\t\t\t\t\t\twidth: itemData.flags?.[PICK_UP_STIX_MODULE_NAME]?.[PICK_UP_STIX_FLAG]?.tokenData?.width ?? 1,\r\n\t\t\t\t\t\theight: itemData.flags?.[PICK_UP_STIX_MODULE_NAME]?.[PICK_UP_STIX_FLAG]?.tokenData?.height ?? 1\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tconst droppedItemFlags: ItemFlags = getProperty(itemData, 'flags.'+PICK_UP_STIX_MODULE_NAME+'.'+PICK_UP_STIX_FLAG);\r\n\r\n\t// if the item being dropped is a container, just create the empty container\r\n\tif (droppedItemFlags?.itemType === ItemType.CONTAINER) {\r\n\t\tlog(` dropItemOnCanvas | dropped item is a container`);\r\n\t\tconst img: string = <string>droppedItemFlags?.container?.imageClosePath;\r\n\r\n\t\treturn lootTokens.length > 0\r\n\t\t\t? !!await createLootToken(tokenData, lootTokens[0].itemId)\r\n\t\t\t: !!await createLootToken(tokenData, {\r\n\t\t\t\t_id: itemData._id,\r\n\t\t\t\tname: itemData.name,\r\n\t\t\t\timg,\r\n\t\t\t\tfolder: getGame().settings.get('pick-up-stix', SettingKeys.tokenFolderId),\r\n\t\t\t\ttype: ItemType.CONTAINER,\r\n\t\t\t\tflags: {\r\n\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\t...droppedItemFlags\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} as ItemData);\r\n\t}\r\n\r\n\tlog(` dropItemOnCanvas | Dropped item is not a container`);\r\n\r\n\t// if we don't have any loot tokens already associated with the item, we'll create a new\r\n\t// loot token\r\n\tif (!dropData.actor) {\r\n\t\tlog(` dropItemOnCanvas | Dropped item comes from an actor`);\r\n\r\n\t \tif (lootTokens.length === 0) {\r\n\t\t\tlog(` dropItemOnCanvas | No LootTokens for the dropped item currently`);\r\n\t\t\tconst lootType = await chooseLootTokenType();\r\n\r\n\t\t\tif (lootType === ItemType.ITEM) {\r\n\t\t\t\treturn !!await createLootToken(\r\n\t\t\t\t\ttokenData,\r\n\t\t\t\t\t<ItemData>mergeObject(itemData, {\r\n\t\t\t\t\t\tflags: {\r\n\t\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\t\t\titemType: ItemType.ITEM\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\telse if (lootType === ItemType.CONTAINER) {\r\n\t\t\t\tconst img: string = <string>getGame().settings.get(PICK_UP_STIX_MODULE_NAME, SettingKeys.closeImagePath);\r\n\r\n\t\t\t\treturn !!await createLootToken(\r\n\t\t\t\t\t{ ...tokenData, img },\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tname: 'Empty Container',\r\n\t\t\t\t\t\timg,\r\n\t\t\t\t\t\ttype: ItemType.CONTAINER,\r\n\t\t\t\t\t\tflags: {\r\n\t\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\t\t\ttokenData: mergeObject({\r\n\t\t\t\t\t\t\t\t\t\tdisposition: 0,\r\n\t\t\t\t\t\t\t\t\t\twidth: itemData.flags?.[PICK_UP_STIX_MODULE_NAME]?.[PICK_UP_STIX_FLAG]?.tokenData?.width ?? 1,\r\n\t\t\t\t\t\t\t\t\t\theight: itemData.flags?.[PICK_UP_STIX_MODULE_NAME]?.[PICK_UP_STIX_FLAG]?.tokenData?.height ?? 1,\r\n\t\t\t\t\t\t\t\t\t\tname: 'Empty Container',\r\n\t\t\t\t\t\t\t\t\t\timg\r\n\t\t\t\t\t\t\t\t\t}, {  ...tokenData, img } ),\r\n\t\t\t\t\t\t\t\t\titemType: ItemType.CONTAINER,\r\n\t\t\t\t\t\t\t\t\tcontainer: {\r\n\t\t\t\t\t\t\t\t\t\tcurrency: Object.keys(getCurrencyTypes()).reduce((acc, shortName) => ({ ...acc, [shortName]: 0 }), {}),\r\n\t\t\t\t\t\t\t\t\t\timageClosePath: img,\r\n\t\t\t\t\t\t\t\t\t\timageOpenPath: getGame().settings.get(PICK_UP_STIX_MODULE_NAME, SettingKeys.openImagePath),\r\n\t\t\t\t\t\t\t\t\t\tsoundOpenPath: getGame().settings.get(PICK_UP_STIX_MODULE_NAME, SettingKeys.defaultContainerOpenSound),\r\n\t\t\t\t\t\t\t\t\t\tsoundClosePath: getGame().settings.get(PICK_UP_STIX_MODULE_NAME, SettingKeys.defaultContainerCloseSound),\r\n\t\t\t\t\t\t\t\t\t\tloot: getGame().settings.get(PICK_UP_STIX_MODULE_NAME, SettingKeys.addItemOnContainerCreation)\r\n\t\t\t\t\t\t\t\t\t\t\t? {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t[itemData.type]: [\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmergeObject(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\titemData,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t...expandObject({\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t[getQuantityDataPath()]: 1\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t]\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t: null\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} as ItemData\r\n\t\t\t\t)\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\tlog(` dropItemOnCanvas | LootTokens for the dropped item already exist, create new token with same item data`);\r\n\t\t\t// we already have loot tokens, so create a new loot token but use the previous item ID\r\n\t\t\treturn !!await createLootToken(\r\n\t\t\t\t{ ...tokenData },\r\n\t\t\t\titemData._id\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\tlog(` dropItemOnCanvas | Dropped data comes from actor '${dropData.actor.name}', delete it first`);\r\n\tawait deleteOwnedItem(dropData.actor.id, itemData._id);\r\n\r\n\treturn !!await createLootToken(\r\n\t\t{ ...tokenData },\r\n\t\t<ItemData>mergeObject(itemData, {\r\n\t\t\tflags: {\r\n\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\titemType: ItemType.ITEM\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})\r\n\t);\r\n}\r\n\r\n/**\r\n * Api for creating a container with specified items inside at desired position\r\n * @param items array of items\r\n * @param currency obect like {cp:0, sp:0, gp:0, pp:0}\r\n * @param position object like {gridX:0, gridY:0}\r\n * @param tokenDataOverride available values to override are width, height , closeImg, openImg\r\n */\r\nexport const makeContainerApi = async (items, currency, position, tokenDataOverride = {width:1,height:1, closeImg:\"\", openImg:\"\" }) => {\r\n\tlog(` makeContainerApi:`);\r\n\tlog([items, currency, position]);\r\n\r\n\tlet lootData = {};\r\n\r\n\titems.forEach((item) => {\r\n\t\tmergeObject(item, {\r\n\t\t\tflags: {\r\n\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\ttokenData: {\r\n\t\t\t\t\t\t\twidth: 1,\r\n\t\t\t\t\t\t\theight: 1\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tif (lootData[item.data.type]) {\r\n\t\t\tlootData[item.data.type].push(item.data);\r\n\t\t} else {\r\n\t\t\tlootData[item.data.type] = [item.data];\r\n\t\t}\r\n\t});\r\n\r\n\tlet tokenData: TokenData = {\r\n\t\tname: 'Container',\r\n\t\tdisposition: 0,\r\n\t\timg: '',\r\n\t\twidth: tokenDataOverride.width,\r\n\t\theight: tokenDataOverride.height,\r\n\t\tx: position.gridX,\r\n\t\ty: position.gridY,\r\n\t\tflags: {\r\n\t\t\t'pick-up-stix': {\r\n\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\tisOpen: false,\r\n\t\t\t\t\tminPerceiveValue: 0\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t};\r\n\r\n\tconst img: string = <string>(tokenDataOverride?.closeImg) || <string>getGame().settings.get(\r\n\t\tPICK_UP_STIX_MODULE_NAME,\r\n\t\tSettingKeys.closeImagePath\r\n\t);\r\n\r\n\treturn !!(await createLootToken({ ...tokenData, img }, {\r\n\t\tname: 'Container',\r\n\t\timg,\r\n\t\ttype: ItemType.CONTAINER,\r\n\t\tflags: {\r\n\t\t\t'pick-up-stix': {\r\n\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\ttokenData: mergeObject(\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tdisposition: 0,\r\n\t\t\t\t\t\t\twidth: 1,\r\n\t\t\t\t\t\t\theight: 1,\r\n\t\t\t\t\t\t\tname: 'Container',\r\n\t\t\t\t\t\t\timg\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t{ ...tokenData, img }\r\n\t\t\t\t\t),\r\n\t\t\t\t\titemType: ItemType.CONTAINER,\r\n\t\t\t\t\tcontainer: {\r\n\t\t\t\t\t\tcurrency: Object.keys(getCurrencyTypes()).reduce(\r\n\t\t\t\t\t\t\t(acc, shortName) => ({\r\n\t\t\t\t\t\t\t\t...acc,\r\n\t\t\t\t\t\t\t\t[shortName]: currency[shortName] || 0\r\n\t\t\t\t\t\t\t}),\r\n\t\t\t\t\t\t\t{}\r\n\t\t\t\t\t\t),\r\n\t\t\t\t\t\timageClosePath: img,\r\n\t\t\t\t\t\timageOpenPath: tokenDataOverride.openImg || getGame().settings.get(\r\n\t\t\t\t\t\t\tPICK_UP_STIX_MODULE_NAME,\r\n\t\t\t\t\t\t\tSettingKeys.openImagePath\r\n\t\t\t\t\t\t),\r\n\t\t\t\t\t\tsoundOpenPath: getGame().settings.get(\r\n\t\t\t\t\t\t\tPICK_UP_STIX_MODULE_NAME,\r\n\t\t\t\t\t\t\tSettingKeys.defaultContainerOpenSound\r\n\t\t\t\t\t\t),\r\n\t\t\t\t\t\tsoundClosePath: getGame().settings.get(\r\n\t\t\t\t\t\t\tPICK_UP_STIX_MODULE_NAME,\r\n\t\t\t\t\t\t\tSettingKeys.defaultContainerCloseSound\r\n\t\t\t\t\t\t),\r\n\t\t\t\t\t\tloot: lootData\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t} as ItemData));\r\n};\r\n\r\nconst chooseLootTokenType = (): Promise<ItemType> => {\r\n\tlog(` chooseLootTokenType | creating dialog`);\r\n\treturn new Promise(resolve => {\r\n\t\t// render the item type selection form\r\n\t\tnew Dialog({\r\n\t\t\tcontent: 'What kind of loot is this?',\r\n\t\t\tdefault: 'one',\r\n\t\t\ttitle: 'Loot Type',\r\n\t\t\tbuttons: {\r\n\t\t\t\tone: {\r\n\t\t\t\t\ticon: '<i class=\"fas fa-box\"></i>',\r\n\t\t\t\t\tlabel: 'Item',\r\n\t\t\t\t\tcallback: async () => {\r\n\t\t\t\t\t\tlog(` chooseLootTokenType | '${ItemType.ITEM}' type chosen`);\r\n\t\t\t\t\t\tresolve(ItemType.ITEM);\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\ttwo: {\r\n\t\t\t\t\ticon: '<i class=\"fas fa-boxes\"></i>',\r\n\t\t\t\t\tlabel: 'Container',\r\n\t\t\t\t\tcallback: async () => {\r\n\t\t\t\t\t\tlog(` chooseLootTokenType | '${ItemType.CONTAINER}' type chosen`);\r\n\t\t\t\t\t\tresolve(ItemType.CONTAINER);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}).render(true);\r\n\t});\r\n}\r\n\r\nexport const createLootToken: CreateLootToken = async (tokenData: any, itemData: any, notify: boolean=true) => {\r\n\tlog(` createLootToken:`)\r\n\tlog([tokenData, itemData, notify]);\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tif (typeof itemData === 'object') {\r\n\t\t\titemData = await createItem({\r\n\t\t\t\t...itemData,\r\n\t\t\t\tpermission: {\r\n\t\t\t\t\tdefault: 2\r\n\t\t\t\t},\r\n\t\t\t\tfolder: getGame().settings.get('pick-up-stix', SettingKeys.tokenFolderId),\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (typeof tokenData === 'object') {\r\n\t\t\ttokenData = await createToken({\r\n\t\t\t\t...tokenData,\r\n\t\t\t\tflags: {\r\n\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\titemId: itemData\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tconst t = new LootToken(tokenData, itemData);\r\n\tlootTokens.push(t);\r\n\r\n\tif (notify) {\r\n\t\tconst msg: SocketMessage = {\r\n\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\ttype: SocketMessageType.lootTokenCreated,\r\n\t\t\tdata: {\r\n\t\t\t\ttokenId: tokenData\r\n\t\t\t}\r\n\t\t}\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t\tHooks.callAll(PickUpStixHooks.lootTokenCreated, msg.data.tokenId);\r\n\t}\r\n\r\n\treturn t;\r\n}\r\n\r\nexport const deleteToken = async (tokenId: string, sceneId: string): Promise<string> => {\r\n\tlog(` deleteToken with args:`);\r\n\tlog([tokenId, sceneId]);\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tlog(` deleteToken | user is GM, deleting token '${tokenId}' from scene '${sceneId}'`);\r\n\t\tconst scene = getGame().scenes?.get(sceneId);//Scene.collection.get(sceneId);\r\n\t\tlet array = [tokenId];\r\n\t\t//@ts-ignore\r\n\t\tconst _id = <string>(<Document<any,any>[]>await scene?.deleteEmbeddedDocuments('Token', array))[0].id;\r\n\t\treturn _id;\r\n\t}\r\n\r\n\treturn new Promise((resolve) => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\tresolve(\"\");\r\n\t\t}, gmActionTimeout());\r\n\r\n\t\tconst msg: SocketMessage = {\r\n\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\ttype: SocketMessageType.deleteToken,\r\n\t\t\tdata: {\r\n\t\t\t\ttokenId,\r\n\t\t\t\tsceneId\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tHooks.once('deleteToken', (scene, data, options, userId) => {\r\n\t\t\tlog(` deleteToken | deleteToken hook`);\r\n\t\t\tclearTimeout(timeout);\r\n\t\t\tresolve(data._id);\r\n\t\t});\r\n\r\n\t\tlog(` deleteToken | user is not GM, sending socket msg:`);\r\n\t\tlog([msg]);\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t});\r\n}\r\n\r\nexport async function updateToken(sceneId: string, updates: { _id: string; [key: string]: any } | { _id: string; [key: string]: any }[]): Promise<{ tokenId: string; sceneId: string }> {\r\n\tlog(` updateToken with args:`);\r\n\tlog([sceneId, updates]);\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tlog(` updateToken | user is GM, making update`);\r\n\t\tconst scene = getGame().scenes?.get(sceneId);//Scene.collection.get(sceneId);\r\n\t\tlet record:Record<string, unknown> = initiateRecord<unknown>(updates, null);\r\n\t\tlet array = [record];\r\n\t\t//@ts-ignore\r\n\t\tconst _id = <string>(<Document<any,any>[]>await scene?.updateEmbeddedDocuments('Token', array))[0].id;\r\n\t\treturn { tokenId: _id, sceneId: sceneId };\r\n\t}\r\n\r\n\tconst msg: SocketMessage = {\r\n\t\tsender: <string>getGame().user?.id,\r\n\t\ttype: SocketMessageType.updateToken,\r\n\t\tdata: {\r\n\t\t\tsceneId,\r\n\t\t\tupdates\r\n\t\t}\r\n\t}\r\n\r\n\treturn new Promise(resolve => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\tresolve({ tokenId: \"\", sceneId: \"\" });\r\n\t\t}, gmActionTimeout());\r\n\r\n\t\tHooks.once('updateToken', (scene, tokenData, options, userId) => {\r\n\t\t\tlog(` updateToken | updateToken hook`);\r\n\t\t\tclearTimeout(timeout);\r\n\t\t\tresolve({ tokenId: tokenData._id, sceneId: sceneId });\r\n\t\t});\r\n\r\n\t\tlog(` updateToken | user is not GM, sending socket msg:`);\r\n\t\tlog([msg]);\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t});\r\n}\r\n\r\nexport async function updateItem(id, updates): Promise<string> {\r\n\tlog(` updateItem:`);\r\n\tlog([id, updates]);\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tlog(' updateItem | user is GM, making update');\r\n\t\tconst entity = <Item>getGame().items?.get(id);\r\n\t\tconst _id = <string>(await entity.update(updates, {}))?.id;\r\n\t\treturn _id;\r\n\t}\r\n\r\n\treturn new Promise(resolve => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\tresolve(\"\");\r\n\t\t}, gmActionTimeout());\r\n\r\n\t\tconst msg: SocketMessage = {\r\n\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\ttype: SocketMessageType.updateItem,\r\n\t\t\tdata: {\r\n\t\t\t\tid,\r\n\t\t\t\tupdates\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tHooks.once('updateItem', (entity, data, options, userId) => {\r\n\t\t\tlog(` updateItem | updateItem hook`);\r\n\t\t\tclearTimeout(timeout);\r\n\t\t\tresolve(entity.id);\r\n\t\t});\r\n\r\n\t\tlog(` updateItem | user is not GM, sending socket msg:`);\r\n\t\tlog([msg]);\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t});\r\n}\r\n\r\nexport async function updateActor(actor: Actor, updates): Promise<string> {\r\n\tlog(' updateActor | called with args:');\r\n\tlog([actor, updates]);\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tlog(` updateActor | user is GM, udating actor`);\r\n\t\tconst _id = <string>(await actor.update(updates))?.id;\r\n\t\treturn _id;\r\n\t}\r\n\r\n\treturn new Promise((resolve) => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\tresolve(\"\");\r\n\t\t}, gmActionTimeout());\r\n\r\n\t\tconst msg: SocketMessage = {\r\n\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\ttype: SocketMessageType.updateActor,\r\n\t\t\tdata: {\r\n\t\t\t\tactorId: actor.id,\r\n\t\t\t\tupdates\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tHooks.once('updateActor', (actor, data, options, userId) => {\r\n\t\t\tlog(` updateActor | updateActor hook`);\r\n\t\t\tclearTimeout(timeout);\r\n\t\t\tresolve(actor.id);\r\n\t\t});\r\n\r\n\t\tlog(` updateActor | user is not GM, sending socket msg:`);\r\n\t\tlog([msg]);\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t});\r\n}\r\n\r\nexport async function createOwnedItem(actorId: string, data: any | any[]): Promise<boolean> {\r\n\tlog('pick-up-stix | createOwnedItem | called with args:');\r\n\tdata = Array.isArray(data) ? data : [data];\r\n\tlog([actorId, data]);\r\n\r\n\tconst actor = getGame().actors?.get(actorId);\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tlog(` createOwnedItem | user is GM, creating owned item`);\r\n\t\tawait actor?.createEmbeddedDocuments(data);\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn new Promise((resolve) => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\tresolve(false);\r\n\t\t}, gmActionTimeout());\r\n\r\n\t\tconst msg: SocketMessage = {\r\n\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\ttype: SocketMessageType.createOwnedItem,\r\n\t\t\tdata: {\r\n\t\t\t\tactorId,\r\n\t\t\t\titems: data\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tHooks.once('createOwnedItem', (actor, item, options, userId) => {\r\n\t\t\tlog(` createOwnedItem | createOwnedItem hook | item '${item._id}' created`);\r\n\t\t\tclearTimeout(timeout);\r\n\t\t\tresolve(true);\r\n\t\t});\r\n\r\n\t\tlog(` createOwnedItem | user is not GM, sending socket msg:`);\r\n\t\tlog([msg]);\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t});\r\n}\r\n\r\n/**\r\n *\r\n * @param data\r\n * @param options\r\n *\r\n * @returns The ID of the Item entity created or null if it was not created\r\n */\r\nexport const createItem = async (data: any, options: any = {}): Promise<string> => {\r\n\tlog(` createItem | called with args:`);\r\n\tlog([data]);\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tlog(` createItem | user is GM, creating entity`);\r\n\t\tconst e = <Item>await Item.create(data, options);\r\n\t\treturn <string>e.id;\r\n\t}\r\n\r\n\treturn new Promise((resolve) => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\tresolve(\"\");\r\n\t\t}, gmActionTimeout());\r\n\r\n\t\tconst msg: SocketMessage = {\r\n\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\ttype: SocketMessageType.createItem,\r\n\t\t\tdata: {\r\n\t\t\t\tdata,\r\n\t\t\t\toptions\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tHooks.once('createItem', (item, options, userId) => {\r\n\t\t\tlog(` createItem | createItem hook | item '${item.id}' created`);\r\n\t\t\tclearTimeout(timeout);\r\n\t\t\tresolve(item.id);\r\n\t\t});\r\n\r\n\t\tlog(` createItem | user is not GM, sending socket msg:`);\r\n\t\tlog([msg]);\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t});\r\n}\r\n\r\nexport const deleteOwnedItem = async (actorId: string, itemId: string): Promise<{ actorId: string; itemId: string }> => {\r\n\tlog(' deleteOwnedItem | called with args:');\r\n\tlog([actorId, itemId]);\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tlog(` deleteOwnedItem | user is GM, deleting owned item`);\r\n\t\tconst actor = getGame().actors?.get(actorId);\r\n\t\tawait actor?.deleteEmbeddedDocuments(actor.documentName,[itemId]);\r\n\t\treturn { actorId, itemId };\r\n\t}\r\n\r\n\tconst msg: SocketMessage = {\r\n\t\tsender: <string>getGame().user?.id,\r\n\t\ttype: SocketMessageType.deleteOwnedItem,\r\n\t\tdata: {\r\n\t\t\tactorId,\r\n\t\t\titemId\r\n\t\t}\r\n\t}\r\n\r\n\treturn new Promise((resolve) => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\tresolve({ actorId: \"\", itemId: \"\" });\r\n\t\t}, gmActionTimeout());\r\n\r\n\t\tHooks.once('deleteOwnedItem', (actor, itemData, options, userId) => {\r\n\t\t\tlog(' deleteOwnedItem | deleteOwnedItem hook');\r\n\t\t\tclearTimeout(timeout);\r\n\t\t\tresolve({ actorId, itemId });\r\n\t\t});\r\n\r\n\t\tlog(' deleteOwnedItem | user is not GM, sending socket msg:');\r\n\t\tlog([msg]);\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t});\r\n}\r\n\r\nexport const deleteItem = async (id: string): Promise<string|null> => {\r\n\tlog(' deleteItem | called with args:');\r\n\tlog([id]);\r\n\r\n\tconst e = getGame().items?.get(id);\r\n\r\n\tif (!e) {\r\n\t\tlog(` deleteItem | Item '${id}' not found`);\r\n\t\treturn null;\r\n\t}\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tlog(` deleteItem | user is GM, deleting entity`);\r\n\t\tawait e.delete();\r\n\t\treturn id;\r\n\t}\r\n\r\n\tconst msg: SocketMessage = {\r\n\t\tsender: <string>getGame().user?.id,\r\n\t\ttype: SocketMessageType.deleteItem,\r\n\t\tdata: {\r\n\t\t\tid\r\n\t\t}\r\n\t}\r\n\r\n\treturn new Promise((resolve) => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\tresolve(null);\r\n\t\t}, gmActionTimeout());\r\n\r\n\t\tHooks.once('deleteItem', (item, options, userId) => {\r\n\t\t\tlog(' deleteItem | deleteItem hook');\r\n\t\t\tclearTimeout(timeout);\r\n\t\t\tresolve(item.id);\r\n\t\t});\r\n\r\n\t\tlog(` deleteItem | user is not GM, sending socket msg:`);\r\n\t\tlog([msg]);\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t});\r\n}\r\n\r\nexport const updateOwnedItem = async (actorId, data): Promise<{ actorId: string; id: string}|null> => {\r\n\tlog(' updateOwnedItem | called with args:');\r\n\tlog([actorId, data]);\r\n\r\n\tconst actor = getGame().actors?.get(actorId);\r\n\r\n\tif (!actor) {\r\n\t\tlog(` updateOwnedItem | Actor '${actorId}' not found`);\r\n\t\treturn null;\r\n\t}\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tlog(` updateOwnedItem | user is GM, updating embedded entity`);\r\n\t\t//@ts-ignore\r\n\t\tconst _id  = <string>(<Document<any,any>[]>await actor.updateEmbeddedDocuments(data))[0].id;\r\n\t\treturn { actorId: <string>actor.id, id: _id };\r\n\t}\r\n\r\n\tconst msg: SocketMessage = {\r\n\t\tsender: <string>getGame().user?.id,\r\n\t\ttype: SocketMessageType.updateOwnedItem,\r\n\t\tdata: {\r\n\t\t\tactorId,\r\n\t\t\tdata\r\n\t\t}\r\n\t}\r\n\r\n\treturn new Promise((resolve) => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\tresolve(null);\r\n\t\t}, gmActionTimeout());\r\n\r\n\t\tHooks.once(`updateOwnedItem`, (parent, data, update, options, userId) => {\r\n\t\t\tlog(` updateOwnedItem | updateOwnedItem hook`);\r\n\t\t\tclearTimeout(timeout);\r\n\t\t\tresolve({ actorId: parent.id, id: data._id });\r\n\t\t});\r\n\r\n\t\tlog(' updateOwnedItem | user is not GM, sending socket msg');\r\n\t\tlog([msg]);\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t})\r\n\r\n}\r\n\r\nexport const createToken = async (data: any): Promise<string> => {\r\n\tlog(` createToken | called with args:`);\r\n\tlog([data]);\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tlog(` createToken | user is GM, creating token`);\r\n\t\tconst t = await Token.create({\r\n\t\t\t...data\r\n\t\t});\r\n\t\treturn <string>t[0].id;\r\n\t}\r\n\r\n\tconst msg: SocketMessage = {\r\n\t\tsender: <string>getGame().user?.id,\r\n\t\ttype: SocketMessageType.createToken,\r\n\t\tdata\r\n\t}\r\n\r\n\treturn new Promise((resolve) => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\tresolve(\"\");\r\n\t\t}, gmActionTimeout());\r\n\r\n\t\tHooks.once('createToken', (scene, data) => {\r\n\t\t\tlog(` createToken | createToken hook | Token '${data.id}' created`);\r\n\t\t\tclearTimeout(timeout);\r\n\t\t\tresolve(data._id);\r\n\t\t});\r\n\r\n\t\tlog(' createToken | user is not GM, sending socket msg:');\r\n\t\tlog([msg]);\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t});\r\n}\r\n\r\nexport const dropItemOnToken = async ({ dropData, targetTokenId }: { dropData: DropData, targetTokenId: string }): Promise<boolean> => {\r\n\tlog(` dropItemOnToken:`);\r\n\tlog([dropData, targetTokenId]);\r\n\r\n\tif (!getGame().user?.isGM) {\r\n\t\treturn new Promise(resolve => {\r\n\t\t\tconst timeout = setTimeout(() => {\r\n\t\t\t\tresolve(false);\r\n\t\t\t}, gmActionTimeout());\r\n\r\n\t\t\tconst msg: SocketMessage = {\r\n\t\t\t\ttype: SocketMessageType.dropItemOnToken,\r\n\t\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tdropData,\r\n\t\t\t\t\ttargetTokenId\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t\t});\r\n\t}\r\n\r\n\tconst targetToken: Token = <Token>getCanvas().tokens?.placeables.find(p => p.id === targetTokenId);\r\n\tconst targetTokenFlags: TokenFlags = <TokenFlags>targetToken.getFlag(PICK_UP_STIX_MODULE_NAME, PICK_UP_STIX_FLAG);\r\n\tconst targetTokenItem = getGame().items?.get(<string>targetTokenFlags?.itemId);\r\n\tconst targetTokenItemFlags: ItemFlags = <ItemFlags>targetTokenItem?.getFlag(PICK_UP_STIX_MODULE_NAME, PICK_UP_STIX_FLAG);\r\n\r\n\tif (!targetToken?.actor && targetTokenItemFlags?.itemType !== ItemType.CONTAINER) {\r\n\t\tui.notifications?.error(`Cannot drop '${dropData.data.name}' onto ${targetToken.name}`);\r\n\t\treturn false;\r\n\t}\r\n\r\n\tlet itemData: any;\r\n\r\n\tif (dropData.actor) {\r\n\t\t// if the dropped item comes from an actor, we need to delete the item from that actor and get the data from the dropped data\r\n\t\tlog(` dropItemOnToken | Actor '${dropData.actor.id}' dropped item '${dropData.data._id}', get item data from the dropped item's original item data`);\r\n\t\titemData = duplicate(dropData.data);\r\n\t\tawait deleteOwnedItem(<string>dropData.actor.id, dropData.data._id);\r\n\t}\r\n\telse {\r\n\t\t// if the dropped item doesn't come from an actor, get it from the game's items or a compendium\r\n\t\tlog(` dropItemOnToken | item comes from directory or compendium, item data comes from directory or compendium`);\r\n\t\tconst pack = <string>dropData.pack;\r\n\t\tconst id = <string>dropData.id;\r\n\t\tconst item: Item = <Item>await getGame().items?.get(id) ?? await getGame().packs.get(pack)?.getEntity(id);\r\n\t\tif (!item) {\r\n\t\t\tlog(` dropItemOnToken | item '${id}' not found in game items or compendium`);\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\titemData = duplicate(item.data);\r\n\t}\r\n\r\n\tlog(` dropItemOnToken | item data:`);\r\n\tlog([itemData]);\r\n\r\n\tif (targetToken.actor) {\r\n\t\tconst droppedItemFlags: ItemFlags = getProperty(itemData, 'flags.pick-up-stix.pick-up-stix');\r\n\r\n\t\tif (droppedItemFlags.itemType === ItemType.CONTAINER) {\r\n\t\t\tui.notifications?.error('Cannot add a container to a PC/NPC');\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn createOwnedItem(\r\n\t\t\t<string>targetToken.actor.id,\r\n\t\t\tmergeObject(itemData, {\r\n\t\t\t\tdata: {\r\n\t\t\t\t\t[getQuantityDataPath()]: 1\r\n\t\t\t\t},\r\n\t\t\t\tflags: {\r\n\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\towner: targetToken.actor.id\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t).then(result => {\r\n\t\t\tHooks.callAll(PickUpStixHooks.itemDroppedOnToken);\r\n\t\t\tconst msg: SocketMessage = {\r\n\t\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\t\ttype: SocketMessageType.itemDroppedOnToken,\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tdropData,\r\n\t\t\t\t\ttargetTokenId\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t\t\treturn !!result;\r\n\t\t});\r\n\t}\r\n\r\n\treturn addItemToContainer({ itemData, containerItemId: targetTokenItem?.id }).then(result => {\r\n\t\tHooks.callAll(PickUpStixHooks.itemDroppedOnToken);\r\n\t\tconst msg: SocketMessage = {\r\n\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\ttype: SocketMessageType.itemDroppedOnToken,\r\n\t\t\tdata: {\r\n\t\t\t\tdropData,\r\n\t\t\t\ttargetTokenId\r\n\t\t\t}\r\n\t\t}\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t\treturn result;\r\n\t})\r\n}\r\n\r\nexport const addItemToContainer = async (data: { itemData: any, containerItemId: string|null|undefined }): Promise<boolean> => {\r\n\tlog(` addItemToContainer:`);\r\n\tlog([data]);\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tlog(` addItemToContainer | User is GM`);\r\n\r\n\t\tconst itemData = data.itemData;\r\n\t\tconst itemType = itemData.type;\r\n\t\tconst itemFlags: ItemFlags = getProperty(itemData, 'flags.pick-up-stix.pick-up-stix');\r\n\r\n\t\tif (itemFlags?.itemType === ItemType.CONTAINER) {\r\n\t\t\t// if the item being dropped is a container, you can't add it to another token\r\n\t\t\tlog(` addItemToContainer | Cannot add item '${itemData._id}' to container because it's a container`);\r\n\t\t\tui.notifications?.error('A container may only be placed onto an empty square without any tokens.');\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\tconst containerItem = <Item>getGame().items?.get(<string>data.containerItemId);\r\n\t\tconst containerItemFlags: ItemFlags = <ItemFlags>duplicate(containerItem.getFlag(PICK_UP_STIX_MODULE_NAME, PICK_UP_STIX_FLAG));\r\n\t\tconst containerData = <ContainerData>containerItemFlags?.container;\r\n\r\n\t\tlet loot: ContainerLoot = <ContainerLoot>containerData?.loot;\r\n\r\n\t\t// if the container never had any loot, then 'loot' will not exist, so\r\n\t\t// create an empty object\r\n\t\tif (!loot) {\r\n\t\t\tcontainerData.loot = {};\r\n\t\t\tloot = containerData.loot;\r\n\t\t}\r\n\r\n\t\t// if the 'loot' object doesn't have any loot of the type being\r\n\t\t// dropped it'll be undefined, so create an empty array, to hold\r\n\t\t// loot of that item type\r\n\t\tif (!loot[itemType]) {\r\n\t\t\tlog(` addItemToContainer | No items of type '${itemType}', creating new slot`);\r\n\t\t\tloot[itemType] = [];\r\n\t\t}\r\n\r\n\t\tconst qtyDataPath = getQuantityDataPath();\r\n\r\n\t\tconst existingItem = loot[itemType]\r\n\t\t\t?.find(i =>\r\n\t\t\t\ti.name?.toLowerCase() === itemData.name?.toLowerCase()\r\n\t\t\t\t&& i.img === itemData.img\r\n\t\t\t\t&& i.data?.description?.value?.toLowerCase() === itemData.data?.description?.value?.toLowerCase()\r\n\t\t\t\t&& getProperty(i.data, getPriceDataPath()) === getProperty(itemData.data, getPriceDataPath())\r\n\t\t\t\t&& getProperty(i.data, getWeightDataPath()) === getProperty(itemData.data, getWeightDataPath())\r\n\t\t\t);\r\n\r\n\t\tif (existingItem) {\r\n\t\t\tlog(` addItemToContainer | existing data for type '${itemType}', increase quantity by 1`);\r\n\t\t\tsetProperty(existingItem.data, qtyDataPath, +getProperty(existingItem.data, qtyDataPath) + 1)\r\n\t\t}\r\n\t\telse {\r\n\t\t\tlog(` addItemToContainer | existing data for item '${itemData._id}' does not exist, set quantity to 1 and add to slot`);\r\n\t\t\tsetProperty(itemData.data, qtyDataPath, 1);\r\n\t\t\tloot[itemType].push({\r\n\t\t\t\t...itemData\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tawait updateItem(data.containerItemId, {\r\n\t\t\tflags: {\r\n\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\tcontainer: {\r\n\t\t\t\t\t\t\tloot\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tconst msg: SocketMessage = {\r\n\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\ttype: SocketMessageType.itemAddedToContainer,\r\n\t\t\tdata\r\n\t\t}\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t\tHooks.callAll(PickUpStixHooks.itemAddedToContainer, data);\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn new Promise(resolve => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\tresolve(false);\r\n\t\t}, gmActionTimeout());\r\n\r\n\t\tconst msg: SocketMessage = {\r\n\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\ttype: SocketMessageType.addItemToContainer,\r\n\t\t\tdata\r\n\t\t};\r\n\r\n\t\tlog(` addItemToContainer | User is not GM, sending socket msg:`);\r\n\t\tlog([msg]);\r\n\r\n\t\tHooks.once(PickUpStixHooks.itemAddedToContainer, () => {\r\n\t\t\tlog(` addItemToContainer | pick-up-stix.itemAddedToContainer hook | User is not GM, sending socket msg:`);\r\n\t\t\tclearTimeout(timeout);\r\n\t\t\tresolve(true);\r\n\t\t});\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t});\r\n}\r\n\r\nexport const  lootCurrency = async (data: { looterTokenId: string, currencies: any; containerItemId: string }): Promise<boolean> => {\r\n\tlog(` lootCurrency:`);\r\n\tlog([data]);\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tlog(` lootCurrency | User is GM, looting currency`);\r\n\r\n\t\tconst looterToken = <Token>getCanvas().tokens?.placeables.find(p => p.id === data.looterTokenId);\r\n\t\tconst containerItem = getGame().items?.get(data.containerItemId);\r\n\t\tconst containerFlags: ItemFlags = <ItemFlags>duplicate(containerItem?.getFlag(PICK_UP_STIX_MODULE_NAME, PICK_UP_STIX_FLAG));\r\n\t\tconst containerCurrencies = containerFlags?.container?.currency;\r\n\t\tconst currencyToLoot = data.currencies;\r\n\r\n\t\t// get the actor's current currencies\r\n\t\tconst actorCurrency = {\r\n\t\t\t...getProperty(<Object>looterToken.actor?.data, getActorCurrencyPath()) ?? {}\r\n\t\t};\r\n\r\n\t\tObject.keys(actorCurrency).forEach(k => actorCurrency[k] = +(actorCurrency[k] ?? 0) + +currencyToLoot[k]);\r\n\t\tObject.keys(containerCurrencies).forEach(k => containerCurrencies[k] = +containerCurrencies[k] - +currencyToLoot[k]);\r\n\r\n\t\tawait updateActor(<Actor>looterToken.actor, {\r\n\t\t\t[getActorCurrencyPath()]: actorCurrency\r\n\t\t});\r\n\r\n\t\tawait updateItem(data.containerItemId, {\r\n\t\t\tflags: {\r\n\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\tcontainer: {\r\n\t\t\t\t\t\t\tcurrency: {\r\n\t\t\t\t\t\t\t\t...containerCurrencies\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tcurrencyCollected(\r\n\t\t\tlooterToken,\r\n\t\t\tObject.entries(currencyToLoot)\r\n\t\t\t\t.filter(([, v]) => <number>v > 0)\r\n\t\t\t\t.reduce((prev, [k, v]) => { prev[k] = v; return prev; }, {})\r\n\t\t);\r\n\r\n\t\tHooks.callAll(PickUpStixHooks.currencyLooted);\r\n\r\n\t\tconst msg: SocketMessage = {\r\n\t\t\ttype: SocketMessageType.currencyLooted,\r\n\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\tdata\r\n\t\t}\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg)\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn new Promise(resolve => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\tresolve(false);\r\n\t\t}, gmActionTimeout());\r\n\r\n\t\tconst msg: SocketMessage = {\r\n\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\ttype: SocketMessageType.lootCurrency,\r\n\t\t\tdata\r\n\t\t}\r\n\r\n\t\tHooks.once(PickUpStixHooks.currencyLooted, () => {\r\n\t\t\tlog(` lootCurrency | pick-up-stix.currencyLooted hook`);\r\n\t\t\tclearTimeout(timeout);\r\n\t\t\tresolve(true);\r\n\t\t});\r\n\r\n\t\tlog(` lootCurrency | User is not GM, sending socket msg:`);\r\n\t\tlog([msg]);\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t});\r\n}\r\n\r\ninterface LootItemFunction {\r\n\t/**\r\n\t * A\r\n\t */\r\n\t(data: { looterTokenId: string, itemData: ItemData | ItemData[], lootTokenTokenId: string, takeAll: boolean }): Promise<boolean>;\r\n\t/**\r\n\t * B\r\n\t */\r\n\t(data: { looterTokenId: string, itemData: ItemData | ItemData[], containerItemId: string, lootTokenTokenId: string, takeAll: boolean }): Promise<boolean>;\r\n}\r\n\r\nexport const lootItem: LootItemFunction = async (data: any): Promise<boolean> => {\r\n\tlog(` lootItem:`);\r\n\tlog([data]);\r\n\r\n\tif (getGame().user?.isGM) {\r\n\t\tlog(` lootItem | User is GM`);\r\n\r\n\t\tconst qtyLootedById = {};\r\n\t\tconst looterToken = <Token>getCanvas().tokens?.placeables.find(p => p.id === data.looterTokenId);\r\n\t\tconst looterActorId = <string>looterToken.actor?.id;\r\n\t\tconst itemDatas: ItemData[] = Array.isArray(data.itemData) ? data.itemData : [data.itemData];\r\n\t\tconst newItemDatas: ItemData[] = itemDatas.reduce((acc, itemData) => {\r\n\t\t\tconst qty = <number>getProperty(itemData.data, getQuantityDataPath());\r\n\t\t\tconst datas = [];\r\n\t\t\tconst actualQty = data.takeAll ? qty : 1;\r\n      qtyLootedById[itemData._id] = actualQty;\r\n\r\n\t\t\tfor (let i = 0; i < actualQty; i++) {\r\n\t\t\t\tdatas.push(\r\n\t\t\t\t\t//@ts-ignore\r\n\t\t\t\t\tmergeObject(itemData, { data: { [getQuantityDataPath()]: 1 } } as ItemData )\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\treturn acc.concat(datas);\r\n\t\t}, []);\r\n\r\n    log(` lootItem | Items being looted:`);\r\n    log([newItemDatas]);\r\n\r\n\t\tawait createOwnedItem(\r\n\t\t\tlooterActorId,\r\n\t\t\tnewItemDatas\r\n\t\t);\r\n\r\n\t\tif (data.containerItemId) {\r\n\t\t\tconst containerItem = <Item>getGame().items?.get(data.containerItemId);\r\n\t\t\tconst containerItemFlags: ItemFlags = <ItemFlags>duplicate(containerItem?.getFlag(PICK_UP_STIX_MODULE_NAME, PICK_UP_STIX_FLAG) ?? {});\r\n\t\t\tconst sourceLoot: ContainerLoot = <ContainerLoot>containerItemFlags?.container?.loot;\r\n\r\n\t\t\tfor (let [itemType, itemsOfType] of Object.entries(sourceLoot)) {\r\n\t\t\t\tfor (let itemData of itemsOfType) {\r\n\t\t\t\t\tif (qtyLootedById[itemData._id] === undefined) {\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconst oldQty = getProperty(itemData?.data, getQuantityDataPath());\r\n          \t\t\tconst newQty = oldQty - qtyLootedById[itemData._id];\r\n\r\n\t\t\t\t\tif (newQty <= 0) {\r\n\t\t\t\t\t\tlog(` lootItem | Quantity is now 0, removing item from loot`);\r\n\t\t\t\t\t\tsourceLoot?.[itemType]?.findSplice(v => v._id === itemData._id);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n            log(` lootItem | Subtracting one from quantity`);\r\n            mergeObject(\r\n              itemData.data,\r\n              {\r\n                [getQuantityDataPath()]: newQty\r\n              }\r\n            );\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tawait containerItem.update({\r\n\t\t\t\tflags: {\r\n\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t'pick-up-stix': containerItemFlags\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}, {});\r\n\t\t}\r\n\t\telse if (data.lootTokenTokenId) {\r\n\t\t\tconst lootTokenToken: Token = <Token>getCanvas().tokens?.placeables.find(p => p.id === data.lootTokenTokenId);\r\n\t\t\tawait deleteToken(lootTokenToken.id, <string>lootTokenToken.scene.id);\r\n\t\t}\r\n\r\n\t\tconst msg: SocketMessage = {\r\n\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\ttype: SocketMessageType.itemCollected,\r\n\t\t\tdata: {\r\n\t\t\t\ttokenId: data.looterTokenId,\r\n\t\t\t\tactorId: looterToken.actor?.id,\r\n\t\t\t\tsourceItemId: data.containerItemId,\r\n\t\t\t\titemData: data.itemData\r\n\t\t\t}\r\n\t\t};\r\n\r\n    for (const [id, qty] of Object.entries(qtyLootedById)) {\r\n      createItemCollectedChatMessage(\r\n        looterToken,\r\n        mergeObject({\r\n          ...newItemDatas.find(d => d._id === id)\r\n        },\r\n        {\r\n          data: {\r\n            [getQuantityDataPath()]: qty\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t\tHooks.callAll(PickUpStixHooks.itemCollected, data);\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn new Promise(resolve => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\tresolve(false);\r\n\t\t}, gmActionTimeout());\r\n\r\n\t\tconst msg: SocketMessage = {\r\n\t\t\tsender: <string>getGame().user?.id,\r\n\t\t\ttype: SocketMessageType.collectItem,\r\n\t\t\tdata\r\n\t\t}\r\n\r\n\t\tHooks.once(PickUpStixHooks.itemCollected, () => {\r\n\t\t\tlog(` lootItem | pick-up-stix.itemCollected hook`);\r\n\t\t\tclearTimeout(timeout);\r\n\t\t\tresolve(true);\r\n\t\t});\r\n\r\n\t\tlog(` lootItem | User is not GM send msg:`);\r\n\t\tlog([msg]);\r\n\r\n\t\tgetGame().socket?.emit(PICK_UP_STIX_SOCKET, msg);\r\n\t});\r\n}\r\n\r\nexport const currencyCollected = async (token, currency) => {\r\n\tlog(` currencyCollected | called with args:`);\r\n\tlog([token, currency]);\r\n\tlet chatContent = '';\r\n\tObject.entries(currency).forEach(([k, v]) => {\r\n\t\tchatContent += `<span class=\"pick-up-stix-chat-currency ${k}\"></span><span>(${k}) ${v}</span><br />`;\r\n\t});\r\n\tlet content = `<p>Picked up:</p>${chatContent}`;\r\n\tawait ChatMessage.create({\r\n\t\tcontent,\r\n\t\tspeaker: {\r\n\t\t\talias: token.actor.name,\r\n\t\t\tscene: token.scene.id,\r\n\t\t\tactor: token.actor.id,\r\n\t\t\ttoken: token.id\r\n\t\t}\r\n\t});\r\n}\r\n\r\nexport const createItemCollectedChatMessage = async (token, item) => {\r\n\tawait ChatMessage.create({\r\n\t\tcontent: `\r\n\t\t\t<p>Picked up ${item.name} (x${getProperty(item.data, getQuantityDataPath())})</p>\r\n\t\t\t<img src=\"${item.img}\" style=\"width: 40px;\" />\r\n\t\t`,\r\n\t\tspeaker: {\r\n\t\t\talias: token.actor.name,\r\n\t\t\tscene: token.scene.id,\r\n\t\t\tactor: token.actor.id,\r\n\t\t\ttoken: token.id\r\n\t\t}\r\n\t});\r\n}"]}