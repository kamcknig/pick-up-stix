{"version":3,"sources":["module/pick-up-stix/main.ts"],"names":[],"mappings":"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","file":"../../../module/pick-up-stix/main.js","sourcesContent":["import { log } from '../../log';\nimport {\n\tcollidedTokens,\n\tgetActorCurrencyPath,\n\tgetCurrencyTypes,\n\tgetPriceDataPath,\n\tgetQuantityDataPath,\n\tgetWeightDataPath\n} from '../../utils';\nimport {\n\tContainerLoot,\n\tItemData,\n\tItemFlags,\n\tLootToken,\n\tTokenData,\n\tTokenFlags\n} from \"./loot-token\";\nimport {\n\tDropData,\n\tItemType,\n\tPickUpStixHooks,\n\tSocketMessage,\n\tSocketMessageType\n} from \"./models\";\nimport { getCanvas, gmActionTimeout, SettingKeys } from \"./settings\";\n\nexport const lootTokens: LootToken[] = [];\nwindow['lootTokens'] = lootTokens;\n\nexport type CreateLootToken = {\n\t(tokenData: string, itemData: string, notify?: boolean): Promise<LootToken>;\n\t(tokenData: TokenData, itemData: string, notify?: boolean): Promise<LootToken>;\n\t(tokenData: TokenData, itemData: ItemData, notify?: boolean): Promise<LootToken>;\n}\n\nexport const getLootToken = (options: { itemId?: string, tokenId?: string, sceneId?: string }): LootToken[] => {\n\tif (!options.itemId && !options.tokenId && !options.sceneId) {\n\t\tthrow new Error('Must provide itemId, tokenId or sceneId');\n\t}\n\n\treturn lootTokens.filter(lt => {\n\t\tif (options.itemId && options.itemId !== lt.itemId) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (options.sceneId && options.sceneId !== lt.sceneId) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (options.tokenId && options.tokenId !== lt.tokenId) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t});\n};\n\n/**\n * @param data Either a Token or a Token ID\n */\nexport const getValidControlledTokens = (data: string | Token): Token[] => {\n\tlog(`pick-up-stix | getValidControlledTokens:`);\n\tlog([data]);\n\n\tlet token: Token;\n\n\tif (typeof data === 'string') {\n\t\ttoken = getCanvas().tokens.placeables.find(p => p.id === data);\n\t}\n\telse {\n\t\ttoken = data;\n\t}\n\n\tif (!token) {\n\t\tlog(`pick-up-stix | getValidControlledTokens | no token provided so returning nothing`);\n\t\treturn [];\n\t}\n\n\tlog(`pick-up-stix | getValidControlledTokens | Looking for tokens near '${token.id}' '${token.name}`);\n\n\tlog(`pick-up-stix | getValidControlledTokens | looping through currently controlled tokens`);\n\tlog([getCanvas().tokens.controlled]);\n\n\tconst controlled = getCanvas().tokens.controlled.filter(t => {\n\t\tif (!t.actor) {\n\t\t\tlog(`pick-up-stix | getValidControlledTokens | token '${t.id}' '${t.name}' has no actor, skipping`);\n\t\t\treturn false;\n\t\t}\n\n\t\treturn (\n\t\t\tt.x + t.w > token.x - getCanvas().grid.size &&\n\t\t\tt.x < token.x + token.w + getCanvas().grid.size &&\n\t\t\tt.y + t.h > token.y - getCanvas().grid.size &&\n\t\t\tt.y < token.y + token.h + getCanvas().grid.size\n\t\t);\n\t});\n\n\tlog(`pick-up-stix | getValidControlledTokens | controlled tokens within range`);\n\tlog([controlled]);\n\treturn controlled;\n}\n\nexport const normalizeDropData = async (data: Partial<DropData>): Promise<DropData> => {\n\tlog('pick-up-stix | normalizeDropData called with args:');\n\tlog([data]);\n\n\tif (data.actorId) {\n\t\tdata.actor = data.tokenId ? game.actors.tokens[data.tokenId] : game.actors.get(data.actorId);\n\t}\n\n\tconst pack: any = data.pack ? game.packs.get(data.pack) : null;\n\tconst id: string = data.id;\n\tdata.data = data.actor\n\t\t? data.data\n\t\t: (\n\t\t\tpack\n\t\t\t\t? (await pack.getEntity(id))?.data\n\t\t\t\t: game.items.get(id)?.data\n\t\t);\n\n\t// if it's not a container, then we can assume it's an item. Create the item token\n\tconst hg = getCanvas().dimensions.size * .5;\n\tconst { x, y } = getCanvas().grid.getSnappedPosition(data.x - hg, data.y - hg, 1);\n\tdata.gridX = x;\n\tdata.gridY = y;\n\n\treturn data as DropData;\n}\n\n/**\n * Handles data dropped onto the getCanvas().\n *\n * @param dropData\n */\nexport async function handleItemDropped(dropData: DropData): Promise<boolean> {\n\tlog(`pick-up-stix | handleItemDropped | called with args:`);\n\tlog(dropData);\n\n\t// The data here should already be normalized, meaning that if we were able to determine the actor reference,\n\t// it should exist here. So if we have an actor ID but no actor, that means we weren't able to figure out\n\t// which actor this item might have come from.\n\tif (dropData.actorId && !dropData.actor) {\n\t\tui.notifications.error(`Please ensure you are only controlling the token (and only the one token) for the character you're working with.`);\n\t\treturn false;\n\t}\n\n\t// loop through placeables on the map and see if it's being dropped onto a token\n\tconst targetTokens = collidedTokens({ x: dropData.x, y: dropData.y });\n\n\tif (targetTokens.length > 1) {\n\t\tui.notifications.error('You can drop an item onto one and only one target');\n\t\treturn false;\n\t}\n\n\tconst targetToken = targetTokens?.[0];\n\n\treturn targetToken\n\t\t? dropItemOnToken({ targetTokenId: targetToken.id, dropData })\n\t\t: dropItemOnCanvas({ dropData });\n}\n\nconst dropItemOnCanvas = async ({ dropData }) => {\n\tlog(`pick-up-stix | dropItemOnCanvas:`);\n\tlog([dropData]);\n\n\tlet itemData: any = duplicate(dropData.data);\n\tlet lootTokens: LootToken[] = getLootToken({ itemId: itemData._id });\n\n\tlet tokenData: TokenData = mergeObject(\n\t\t{\n\t\t\tname: itemData.name,\n\t\t\tdisposition: 0,\n\t\t\timg: itemData.img,\n\t\t\twidth: 1,\n\t\t\theight: 1,\n\t\t\tx: dropData.gridX,\n\t\t\ty: dropData.gridY,\n\t\t\tflags: {\n\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\tisOpen: false\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\t...itemData.flags?.['pick-up-stix']?.['pick-up-stix']?.tokenData ?? {}\n\t\t}\n\t);\n\n\tmergeObject(itemData, {\n\t\tflags: {\n\t\t\t'pick-up-stix': {\n\t\t\t\t'pick-up-stix': {\n\t\t\t\t\ttokenData: {\n\t\t\t\t\t\twidth: itemData.flags?.['pick-up-stix']?.['pick-up-stix']?.tokenData?.width ?? 1,\n\t\t\t\t\t\theight: itemData.flags?.['pick-up-stix']?.['pick-up-stix']?.tokenData?.height ?? 1\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t});\n\n\tconst droppedItemFlags: ItemFlags = getProperty(itemData, 'flags.pick-up-stix.pick-up-stix');\n\n\t// if the item being dropped is a container, just create the empty container\n\tif (droppedItemFlags?.itemType === ItemType.CONTAINER) {\n\t\tlog(`pick-up-stix | dropItemOnCanvas | dropped item is a container`);\n\t\tconst img: string = droppedItemFlags.container.imageClosePath;\n\n\t\treturn lootTokens.length > 0\n\t\t\t? !!await createLootToken(tokenData, lootTokens[0].itemId)\n\t\t\t: !!await createLootToken(tokenData, {\n\t\t\t\t_id: itemData._id,\n\t\t\t\tname: itemData.name,\n\t\t\t\timg,\n\t\t\t\tfolder: game.settings.get('pick-up-stix', SettingKeys.tokenFolderId),\n\t\t\t\ttype: ItemType.CONTAINER,\n\t\t\t\tflags: {\n\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\t\t...droppedItemFlags\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} as ItemData);\n\t}\n\n\tlog(`pick-up-stix | dropItemOnCanvas | Dropped item is not a container`);\n\n\t// if we don't have any loot tokens already associated with the item, we'll create a new\n\t// loot token\n\tif (!dropData.actor) {\n\t\tlog(`pick-up-stix | dropItemOnCanvas | Dropped item comes from an actor`);\n\n\t \tif (lootTokens.length === 0) {\n\t\t\tlog(`pick-up-stix | dropItemOnCanvas | No LootTokens for the dropped item currently`);\n\t\t\tconst lootType = await chooseLootTokenType();\n\n\t\t\tif (lootType === ItemType.ITEM) {\n\t\t\t\treturn !!await createLootToken(\n\t\t\t\t\ttokenData,\n\t\t\t\t\tmergeObject(itemData, {\n\t\t\t\t\t\tflags: {\n\t\t\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\t\t\t\titemType: ItemType.ITEM\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t}\n\t\t\telse if (lootType === ItemType.CONTAINER) {\n\t\t\t\tconst img: string = <string>game.settings.get('pick-up-stix', SettingKeys.closeImagePath);\n\n\t\t\t\treturn !!await createLootToken(\n\t\t\t\t\t{ ...tokenData, img },\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'Empty Container',\n\t\t\t\t\t\timg,\n\t\t\t\t\t\ttype: ItemType.CONTAINER,\n\t\t\t\t\t\tflags: {\n\t\t\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\t\t\t\ttokenData: mergeObject({\n\t\t\t\t\t\t\t\t\t\tdisposition: 0,\n\t\t\t\t\t\t\t\t\t\twidth: itemData.flags?.['pick-up-stix']?.['pick-up-stix']?.tokenData?.width ?? 1,\n\t\t\t\t\t\t\t\t\t\theight: itemData.flags?.['pick-up-stix']?.['pick-up-stix']?.tokenData?.height ?? 1,\n\t\t\t\t\t\t\t\t\t\tname: 'Empty Container',\n\t\t\t\t\t\t\t\t\t\timg\n\t\t\t\t\t\t\t\t\t}, {  ...tokenData, img } ),\n\t\t\t\t\t\t\t\t\titemType: ItemType.CONTAINER,\n\t\t\t\t\t\t\t\t\tcontainer: {\n\t\t\t\t\t\t\t\t\t\tcurrency: Object.keys(getCurrencyTypes()).reduce((acc, shortName) => ({ ...acc, [shortName]: 0 }), {}),\n\t\t\t\t\t\t\t\t\t\timageClosePath: img,\n\t\t\t\t\t\t\t\t\t\timageOpenPath: game.settings.get('pick-up-stix', SettingKeys.openImagePath),\n\t\t\t\t\t\t\t\t\t\tsoundOpenPath: game.settings.get('pick-up-stix', SettingKeys.defaultContainerOpenSound),\n\t\t\t\t\t\t\t\t\t\tsoundClosePath: game.settings.get('pick-up-stix', SettingKeys.defaultContainerCloseSound),\n\t\t\t\t\t\t\t\t\t\tloot: game.settings.get('pick-up-stix', SettingKeys.addItemOnContainerCreation)\n\t\t\t\t\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\t\t\t\t\t[itemData.type]: [\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tmergeObject(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\titemData,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t...expandObject({\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t[getQuantityDataPath()]: 1\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t: null\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} as ItemData\n\t\t\t\t)\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tlog(`pick-up-stix | dropItemOnCanvas | LootTokens for the dropped item already exist, create new token with same item data`);\n\t\t\t// we already have loot tokens, so create a new loot token but use the previous item ID\n\t\t\treturn !!await createLootToken(\n\t\t\t\t{ ...tokenData },\n\t\t\t\titemData._id\n\t\t\t);\n\t\t}\n\t}\n\n\tlog(`pick-up-stix | dropItemOnCanvas | Dropped data comes from actor '${dropData.actor.name}', delete it first`);\n\tawait deleteOwnedItem(dropData.actor.id, itemData._id);\n\n\treturn !!await createLootToken(\n\t\t{ ...tokenData },\n\t\tmergeObject(itemData, {\n\t\t\tflags: {\n\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\titemType: ItemType.ITEM\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t);\n}\n\n/**\n * Api for creating a container with specified items inside at desired position\n * @param items array of items\n * @param currency obect like {cp:0, sp:0, gp:0, pp:0}\n * @param position object like {gridX:0, gridY:0}\n * @param tokenDataOverride available values to override are width, height , closeImg, openImg\n */\nexport const makeContainerApi = async (items, currency, position, tokenDataOverride = {width:1,height:1, closeImg:undefined, openImg:undefined }) => {\n\tlog(`pick-up-stix | makeContainerApi:`);\n\tlog([items, currency, position]);\n\n\tlet lootData = {};\n\n\titems.forEach((item) => {\n\t\tmergeObject(item, {\n\t\t\tflags: {\n\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\ttokenData: {\n\t\t\t\t\t\t\twidth: 1,\n\t\t\t\t\t\t\theight: 1\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (lootData[item.data.type]) {\n\t\t\tlootData[item.data.type].push(item.data);\n\t\t} else {\n\t\t\tlootData[item.data.type] = [item.data];\n\t\t}\n\t});\n\n\tlet tokenData: TokenData = {\n\t\tname: 'Container',\n\t\tdisposition: 0,\n\t\timg: '',\n\t\twidth: tokenDataOverride.width,\n\t\theight: tokenDataOverride.height,\n\t\tx: position.gridX,\n\t\ty: position.gridY,\n\t\tflags: {\n\t\t\t'pick-up-stix': {\n\t\t\t\t'pick-up-stix': {\n\t\t\t\t\tisOpen: false,\n\t\t\t\t\tminPerceiveValue: 0\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\n\tconst img: string = tokenDataOverride.closeImg || game.settings.get(\n\t\t'pick-up-stix',\n\t\tSettingKeys.closeImagePath\n\t);\n\n\treturn !!(await createLootToken({ ...tokenData, img }, {\n\t\tname: 'Container',\n\t\timg,\n\t\ttype: ItemType.CONTAINER,\n\t\tflags: {\n\t\t\t'pick-up-stix': {\n\t\t\t\t'pick-up-stix': {\n\t\t\t\t\ttokenData: mergeObject(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tdisposition: 0,\n\t\t\t\t\t\t\twidth: 1,\n\t\t\t\t\t\t\theight: 1,\n\t\t\t\t\t\t\tname: 'Container',\n\t\t\t\t\t\t\timg\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{ ...tokenData, img }\n\t\t\t\t\t),\n\t\t\t\t\titemType: ItemType.CONTAINER,\n\t\t\t\t\tcontainer: {\n\t\t\t\t\t\tcurrency: Object.keys(getCurrencyTypes()).reduce(\n\t\t\t\t\t\t\t(acc, shortName) => ({\n\t\t\t\t\t\t\t\t...acc,\n\t\t\t\t\t\t\t\t[shortName]: currency[shortName] || 0\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t{}\n\t\t\t\t\t\t),\n\t\t\t\t\t\timageClosePath: img,\n\t\t\t\t\t\timageOpenPath: tokenDataOverride.openImg || game.settings.get(\n\t\t\t\t\t\t\t'pick-up-stix',\n\t\t\t\t\t\t\tSettingKeys.openImagePath\n\t\t\t\t\t\t),\n\t\t\t\t\t\tsoundOpenPath: game.settings.get(\n\t\t\t\t\t\t\t'pick-up-stix',\n\t\t\t\t\t\t\tSettingKeys.defaultContainerOpenSound\n\t\t\t\t\t\t),\n\t\t\t\t\t\tsoundClosePath: game.settings.get(\n\t\t\t\t\t\t\t'pick-up-stix',\n\t\t\t\t\t\t\tSettingKeys.defaultContainerCloseSound\n\t\t\t\t\t\t),\n\t\t\t\t\t\tloot: lootData\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} as ItemData));\n};\n\nconst chooseLootTokenType = (): Promise<ItemType> => {\n\tlog(`pick-up-stix | chooseLootTokenType | creating dialog`);\n\treturn new Promise(resolve => {\n\t\t// render the item type selection form\n\t\tnew Dialog({\n\t\t\tcontent: 'What kind of loot is this?',\n\t\t\tdefault: 'one',\n\t\t\ttitle: 'Loot Type',\n\t\t\tbuttons: {\n\t\t\t\tone: {\n\t\t\t\t\ticon: '<i class=\"fas fa-box\"></i>',\n\t\t\t\t\tlabel: 'Item',\n\t\t\t\t\tcallback: async () => {\n\t\t\t\t\t\tlog(`pick-up-stix | chooseLootTokenType | '${ItemType.ITEM}' type chosen`);\n\t\t\t\t\t\tresolve(ItemType.ITEM);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\ttwo: {\n\t\t\t\t\ticon: '<i class=\"fas fa-boxes\"></i>',\n\t\t\t\t\tlabel: 'Container',\n\t\t\t\t\tcallback: async () => {\n\t\t\t\t\t\tlog(`pick-up-stix | chooseLootTokenType | '${ItemType.CONTAINER}' type chosen`);\n\t\t\t\t\t\tresolve(ItemType.CONTAINER);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}).render(true);\n\t});\n}\n\nexport const createLootToken: CreateLootToken = async (tokenData: any, itemData: any, notify: boolean=true) => {\n\tlog(`pick-up-stix | createLootToken:`)\n\tlog([tokenData, itemData, notify]);\n\n\tif (game.user.isGM) {\n\t\tif (typeof itemData === 'object') {\n\t\t\titemData = await createItem({\n\t\t\t\t...itemData,\n\t\t\t\tpermission: {\n\t\t\t\t\tdefault: 2\n\t\t\t\t},\n\t\t\t\tfolder: game.settings.get('pick-up-stix', SettingKeys.tokenFolderId),\n\t\t\t});\n\t\t}\n\n\t\tif (typeof tokenData === 'object') {\n\t\t\ttokenData = await createToken({\n\t\t\t\t...tokenData,\n\t\t\t\tflags: {\n\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\t\titemId: itemData\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tconst t = new LootToken(tokenData, itemData);\n\tlootTokens.push(t);\n\n\tif (notify) {\n\t\tconst msg: SocketMessage = {\n\t\t\tsender: game.user.id,\n\t\t\ttype: SocketMessageType.lootTokenCreated,\n\t\t\tdata: {\n\t\t\t\ttokenId: tokenData\n\t\t\t}\n\t\t}\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t\tHooks.callAll(PickUpStixHooks.lootTokenCreated, msg.data.tokenId);\n\t}\n\n\treturn t;\n}\n\nexport const deleteToken = async (tokenId: string, sceneId: string): Promise<string> => {\n\tlog(`pick-up-stix | deleteToken with args:`);\n\tlog([tokenId, sceneId]);\n\n\tif (game.user.isGM) {\n\t\tlog(`pick-up-stix | deleteToken | user is GM, deleting token '${tokenId}' from scene '${sceneId}'`);\n\t\tconst scene = Scene.collection.get(sceneId);\n\t\tconst { _id } = await scene?.deleteEmbeddedEntity('Token', tokenId);\n\t\treturn _id;\n\t}\n\n\treturn new Promise((resolve) => {\n\t\tconst timeout = setTimeout(() => {\n\t\t\tresolve(null);\n\t\t}, gmActionTimeout());\n\n\t\tconst msg: SocketMessage = {\n\t\t\tsender: game.user.id,\n\t\t\ttype: SocketMessageType.deleteToken,\n\t\t\tdata: {\n\t\t\t\ttokenId,\n\t\t\t\tsceneId\n\t\t\t}\n\t\t}\n\n\t\tHooks.once('deleteToken', (scene, data, options, userId) => {\n\t\t\tlog(`pick-up-stix | deleteToken | deleteToken hook`);\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve(data._id);\n\t\t});\n\n\t\tlog(`pick-up-stix | deleteToken | user is not GM, sending socket msg:`);\n\t\tlog([msg]);\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t});\n}\n\nexport async function updateToken(sceneId: string, updates: { _id: string; [key: string]: any } | { _id: string; [key: string]: any }[]): Promise<{ tokenId: string; sceneId: string }> {\n\tlog(`pick-up-stix | updateToken with args:`);\n\tlog([sceneId, updates]);\n\n\tif (game.user.isGM) {\n\t\tlog(`pick-up-stix | updateToken | user is GM, making update`);\n\t\tconst { _id } = await Scene.collection.get(sceneId).updateEmbeddedEntity('Token', updates);\n\t\treturn { tokenId: _id, sceneId: sceneId };\n\t}\n\n\tconst msg: SocketMessage = {\n\t\tsender: game.user.id,\n\t\ttype: SocketMessageType.updateToken,\n\t\tdata: {\n\t\t\tsceneId,\n\t\t\tupdates\n\t\t}\n\t}\n\n\treturn new Promise(resolve => {\n\t\tconst timeout = setTimeout(() => {\n\t\t\tresolve(null);\n\t\t}, gmActionTimeout());\n\n\t\tHooks.once('updateToken', (scene, tokenData, options, userId) => {\n\t\t\tlog(`pick-up-stix | updateToken | updateToken hook`);\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve({ tokenId: tokenData._id, sceneId });\n\t\t});\n\n\t\tlog(`pick-up-stix | updateToken | user is not GM, sending socket msg:`);\n\t\tlog([msg]);\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t});\n}\n\nexport async function updateItem(id, updates): Promise<string> {\n\tlog(`pick-up-stix | updateItem:`);\n\tlog([id, updates]);\n\n\tif (game.user.isGM) {\n\t\tlog('pick-up-stix | updateItem | user is GM, making update');\n\t\tconst entity = game.items.get(id);\n\t\tconst { _id } = await entity.update(updates, {});\n\t\treturn _id;\n\t}\n\n\treturn new Promise(resolve => {\n\t\tconst timeout = setTimeout(() => {\n\t\t\tresolve(null);\n\t\t}, gmActionTimeout());\n\n\t\tconst msg: SocketMessage = {\n\t\t\tsender: game.user.id,\n\t\t\ttype: SocketMessageType.updateItem,\n\t\t\tdata: {\n\t\t\t\tid,\n\t\t\t\tupdates\n\t\t\t}\n\t\t};\n\n\t\tHooks.once('updateItem', (entity, data, options, userId) => {\n\t\t\tlog(`pick-up-stix | updateItem | updateItem hook`);\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve(entity.id);\n\t\t});\n\n\t\tlog(`pick-up-stix | updateItem | user is not GM, sending socket msg:`);\n\t\tlog([msg]);\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t});\n}\n\nexport async function updateActor(actor: Actor, updates): Promise<string> {\n\tlog('pick-up-stix | updateActor | called with args:');\n\tlog([actor, updates]);\n\n\tif (game.user.isGM) {\n\t\tlog(`pick-up-stix | updateActor | user is GM, udating actor`);\n\t\tconst { _id } = await actor.update(updates);\n\t\treturn _id;\n\t}\n\n\treturn new Promise((resolve) => {\n\t\tconst timeout = setTimeout(() => {\n\t\t\tresolve(null);\n\t\t}, gmActionTimeout());\n\n\t\tconst msg: SocketMessage = {\n\t\t\tsender: game.user.id,\n\t\t\ttype: SocketMessageType.updateActor,\n\t\t\tdata: {\n\t\t\t\tactorId: actor.id,\n\t\t\t\tupdates\n\t\t\t}\n\t\t};\n\n\t\tHooks.once('updateActor', (actor, data, options, userId) => {\n\t\t\tlog(`pick-up-stix | updateActor | updateActor hook`);\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve(actor.id);\n\t\t});\n\n\t\tlog(`pick-up-stix | updateActor | user is not GM, sending socket msg:`);\n\t\tlog([msg]);\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t});\n}\n\nexport async function createOwnedItem(actorId: string, data: any | any[]): Promise<boolean> {\n\tlog('pick-up-stix | createOwnedItem | called with args:');\n\tdata = Array.isArray(data) ? data : [data];\n\tlog([actorId, data]);\n\n\tconst actor = game.actors.get(actorId);\n\n\tif (game.user.isGM) {\n\t\tlog(`pick-up-stix | createOwnedItem | user is GM, creating owned item`);\n\t\tawait actor.createOwnedItem(data);\n\t\treturn true;\n\t}\n\n\treturn new Promise((resolve) => {\n\t\tconst timeout = setTimeout(() => {\n\t\t\tresolve(false);\n\t\t}, gmActionTimeout());\n\n\t\tconst msg: SocketMessage = {\n\t\t\tsender: game.user.id,\n\t\t\ttype: SocketMessageType.createOwnedItem,\n\t\t\tdata: {\n\t\t\t\tactorId,\n\t\t\t\titems: data\n\t\t\t}\n\t\t};\n\n\t\tHooks.once('createOwnedItem', (actor, item, options, userId) => {\n\t\t\tlog(`pick-up-stix | createOwnedItem | createOwnedItem hook | item '${item._id}' created`);\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve(true);\n\t\t});\n\n\t\tlog(`pick-up-stix | createOwnedItem | user is not GM, sending socket msg:`);\n\t\tlog([msg]);\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t});\n}\n\n/**\n *\n * @param data\n * @param options\n *\n * @returns The ID of the Item entity created or null if it was not created\n */\nexport const createItem = async (data: any, options: any = {}): Promise<string> => {\n\tlog(`pick-up-stix | createItem | called with args:`);\n\tlog([data]);\n\n\tif (game.user.isGM) {\n\t\tlog(`pick-up-stix | | createItem | user is GM, creating entity`);\n\t\tconst e = await Item.create(data, options);\n\t\treturn e.id;\n\t}\n\n\treturn new Promise((resolve) => {\n\t\tconst timeout = setTimeout(() => {\n\t\t\tresolve(null);\n\t\t}, gmActionTimeout());\n\n\t\tconst msg: SocketMessage = {\n\t\t\tsender: game.user.id,\n\t\t\ttype: SocketMessageType.createItem,\n\t\t\tdata: {\n\t\t\t\tdata,\n\t\t\t\toptions\n\t\t\t}\n\t\t};\n\n\t\tHooks.once('createItem', (item, options, userId) => {\n\t\t\tlog(`pick-up-stix | createItem | createItem hook | item '${item.id}' created`);\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve(item.id);\n\t\t});\n\n\t\tlog(`pick-up-stix | createItem | user is not GM, sending socket msg:`);\n\t\tlog([msg]);\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t});\n}\n\nexport const deleteOwnedItem = async (actorId: string, itemId: string): Promise<{ actorId: string; itemId: string }> => {\n\tlog('pick-up-stix | deleteOwnedItem | called with args:');\n\tlog([actorId, itemId]);\n\n\tif (game.user.isGM) {\n\t\tlog(`pick-up-stix | deleteOwnedItem | user is GM, deleting owned item`);\n\t\tconst actor = game.actors.get(actorId);\n\t\tawait actor.deleteOwnedItem(itemId);\n\t\treturn { actorId, itemId };\n\t}\n\n\tconst msg: SocketMessage = {\n\t\tsender: game.user.id,\n\t\ttype: SocketMessageType.deleteOwnedItem,\n\t\tdata: {\n\t\t\tactorId,\n\t\t\titemId\n\t\t}\n\t}\n\n\treturn new Promise((resolve) => {\n\t\tconst timeout = setTimeout(() => {\n\t\t\tresolve(null);\n\t\t}, gmActionTimeout());\n\n\t\tHooks.once('deleteOwnedItem', (actor, itemData, options, userId) => {\n\t\t\tlog('pick-up-stix | deleteOwnedItem | deleteOwnedItem hook');\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve({ actorId, itemId });\n\t\t});\n\n\t\tlog('pick-up-stix | deleteOwnedItem | user is not GM, sending socket msg:');\n\t\tlog([msg]);\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t});\n}\n\nexport const deleteItem = async (id: string): Promise<string> => {\n\tlog('pick-up-stix | deleteItem | called with args:');\n\tlog([id]);\n\n\tconst e = game.items.get(id);\n\n\tif (!e) {\n\t\tlog(`pick-up-stix | deleteItem | Item '${id}' not found`);\n\t\treturn null;\n\t}\n\n\tif (game.user.isGM) {\n\t\tlog(`pick-up-stix | deleteItem | user is GM, deleting entity`);\n\t\treturn (<Item>await e.delete())._id;\n\t}\n\n\tconst msg: SocketMessage = {\n\t\tsender: game.user.id,\n\t\ttype: SocketMessageType.deleteItem,\n\t\tdata: {\n\t\t\tid\n\t\t}\n\t}\n\n\treturn new Promise((resolve) => {\n\t\tconst timeout = setTimeout(() => {\n\t\t\tresolve(null);\n\t\t}, gmActionTimeout());\n\n\t\tHooks.once('deleteItem', (item, options, userId) => {\n\t\t\tlog('pick-up-stix | deleteItem | deleteItem hook');\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve(item.id);\n\t\t});\n\n\t\tlog(`pick-up-stix | deleteItem | user is not GM, sending socket msg:`);\n\t\tlog([msg]);\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t});\n}\n\nexport const updateOwnedItem = async (actorId, data): Promise<{ actorId: string; id: string}> => {\n\tlog('pick-up-stix | updateOwnedItem | called with args:');\n\tlog([actorId, data]);\n\n\tconst actor = game.actors.get(actorId);\n\n\tif (!actor) {\n\t\tlog(`pick-up-stix | updateOwnedItem | Actor '${actorId}' not found`);\n\t\treturn null;\n\t}\n\n\tif (game.user.isGM) {\n\t\tlog(`pick-up-stix | updateOwnedItem | user is GM, updating embedded entity`);\n\t\tconst { _id } = await actor.updateOwnedItem(data);\n\t\treturn { actorId: actor.id, id: _id };\n\t}\n\n\tconst msg: SocketMessage = {\n\t\tsender: game.user.id,\n\t\ttype: SocketMessageType.updateOwnedItem,\n\t\tdata: {\n\t\t\tactorId,\n\t\t\tdata\n\t\t}\n\t}\n\n\treturn new Promise((resolve) => {\n\t\tconst timeout = setTimeout(() => {\n\t\t\tresolve(null);\n\t\t}, gmActionTimeout());\n\n\t\tHooks.once(`updateOwnedItem`, (parent, data, update, options, userId) => {\n\t\t\tlog(`pick-up-stix | updateOwnedItem | updateOwnedItem hook`);\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve({ actorId: parent.id, id: data._id });\n\t\t});\n\n\t\tlog('pick-up-stix | updateOwnedItem | user is not GM, sending socket msg');\n\t\tlog([msg]);\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t})\n\n}\n\nexport const createToken = async (data: any): Promise<string> => {\n\tlog(`pick-up-stix | createToken | called with args:`);\n\tlog([data]);\n\n\tif (game.user.isGM) {\n\t\tlog(`pick-up-stix | createToken | user is GM, creating token`);\n\t\tconst t:any = await Token.create({\n\t\t\t...data\n\t\t});\n\t\treturn t.id;\n\t}\n\n\tconst msg: SocketMessage = {\n\t\tsender: game.user.id,\n\t\ttype: SocketMessageType.createToken,\n\t\tdata\n\t}\n\n\treturn new Promise((resolve) => {\n\t\tconst timeout = setTimeout(() => {\n\t\t\tresolve(null);\n\t\t}, gmActionTimeout());\n\n\t\tHooks.once('createToken', (scene, data) => {\n\t\t\tlog(`pick-up-stix | createToken | createToken hook | Token '${data.id}' created`);\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve(data._id);\n\t\t});\n\n\t\tlog('pick-up-stix | createToken | user is not GM, sending socket msg:');\n\t\tlog([msg]);\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t});\n}\n\nexport const dropItemOnToken = async ({ dropData, targetTokenId }: { dropData: DropData, targetTokenId: string }): Promise<boolean> => {\n\tlog(`pick-up-stix | dropItemOnToken:`);\n\tlog([dropData, targetTokenId]);\n\n\tif (!game.user.isGM) {\n\t\treturn new Promise(resolve => {\n\t\t\tconst timeout = setTimeout(() => {\n\t\t\t\tresolve(null);\n\t\t\t}, gmActionTimeout());\n\n\t\t\tconst msg: SocketMessage = {\n\t\t\t\ttype: SocketMessageType.dropItemOnToken,\n\t\t\t\tsender: game.user.id,\n\t\t\t\tdata: {\n\t\t\t\t\tdropData,\n\t\t\t\t\ttargetTokenId\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t\t});\n\t}\n\n\tconst targetToken: Token = getCanvas().tokens.placeables.find(p => p.id === targetTokenId);\n\tconst targetTokenFlags: TokenFlags = <TokenFlags>targetToken.getFlag('pick-up-stix', 'pick-up-stix');\n\tconst targetTokenItem = game.items.get(targetTokenFlags?.itemId);\n\tconst targetTokenItemFlags: ItemFlags = <ItemFlags>targetTokenItem?.getFlag('pick-up-stix', 'pick-up-stix');\n\n\tif (!targetToken?.actor && targetTokenItemFlags?.itemType !== ItemType.CONTAINER) {\n\t\tui.notifications.error(`Cannot drop '${dropData.data.name}' onto ${targetToken.name}`);\n\t\treturn false;\n\t}\n\n\tlet itemData: any;\n\n\tif (dropData.actor) {\n\t\t// if the dropped item comes from an actor, we need to delete the item from that actor and get the data from the dropped data\n\t\tlog(`pick-up-stix | dropItemOnToken | Actor '${dropData.actor.id}' dropped item '${dropData.data._id}', get item data from the dropped item's original item data`);\n\t\titemData = duplicate(dropData.data);\n\t\tawait deleteOwnedItem(dropData.actor.id, dropData.data._id);\n\t}\n\telse {\n\t\t// if the dropped item doesn't come from an actor, get it from the game's items or a compendium\n\t\tlog(`pick-up-stix | dropItemOnToken | item comes from directory or compendium, item data comes from directory or compendium`);\n\t\tconst pack = dropData.pack;\n\t\tconst id = dropData.id;\n\t\tconst item: Item = <Item>(await game.items.get(id) ?? await game.packs.get(pack)?.getEntity(id));\n\t\tif (!item) {\n\t\t\tlog(`pick-up-stix | dropItemOnToken | item '${id}' not found in game items or compendium`);\n\t\t\treturn false;\n\t\t}\n\t\titemData = duplicate(item.data);\n\t}\n\n\tlog(`pick-up-stix | dropItemOnToken | item data:`);\n\tlog([itemData]);\n\n\tif (targetToken.actor) {\n\t\tconst droppedItemFlags: ItemFlags = getProperty(itemData, 'flags.pick-up-stix.pick-up-stix');\n\n\t\tif (droppedItemFlags.itemType === ItemType.CONTAINER) {\n\t\t\tui.notifications.error('Cannot add a container to a PC/NPC');\n\t\t\treturn false;\n\t\t}\n\n\t\treturn createOwnedItem(\n\t\t\ttargetToken.actor.id,\n\t\t\tmergeObject(itemData, {\n\t\t\t\tdata: {\n\t\t\t\t\t[getQuantityDataPath()]: 1\n\t\t\t\t},\n\t\t\t\tflags: {\n\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\t\towner: targetToken.actor.id\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t).then(result => {\n\t\t\tHooks.callAll(PickUpStixHooks.itemDroppedOnToken);\n\t\t\tconst msg: SocketMessage = {\n\t\t\t\tsender: game.user.id,\n\t\t\t\ttype: SocketMessageType.itemDroppedOnToken,\n\t\t\t\tdata: {\n\t\t\t\t\tdropData,\n\t\t\t\t\ttargetTokenId\n\t\t\t\t}\n\t\t\t}\n\t\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t\t\treturn !!result;\n\t\t});\n\t}\n\n\treturn addItemToContainer({ itemData, containerItemId: targetTokenItem.id }).then(result => {\n\t\tHooks.callAll(PickUpStixHooks.itemDroppedOnToken);\n\t\tconst msg: SocketMessage = {\n\t\t\tsender: game.user.id,\n\t\t\ttype: SocketMessageType.itemDroppedOnToken,\n\t\t\tdata: {\n\t\t\t\tdropData,\n\t\t\t\ttargetTokenId\n\t\t\t}\n\t\t}\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t\treturn result;\n\t})\n}\n\nexport const addItemToContainer = async (data: { itemData: any, containerItemId: string }): Promise<boolean> => {\n\tlog(`pick-up-stix | addItemToContainer:`);\n\tlog([data]);\n\n\tif (game.user.isGM) {\n\t\tlog(`pick-up-stix | addItemToContainer | User is GM`);\n\n\t\tconst itemData = data.itemData;\n\t\tconst itemType = itemData.type;\n\t\tconst itemFlags: ItemFlags = getProperty(itemData, 'flags.pick-up-stix.pick-up-stix');\n\n\t\tif (itemFlags?.itemType === ItemType.CONTAINER) {\n\t\t\t// if the item being dropped is a container, you can't add it to another token\n\t\t\tlog(`pick-up-stix | addItemToContainer | Cannot add item '${itemData._id}' to container because it's a container`);\n\t\t\tui.notifications.error('A container may only be placed onto an empty square without any tokens.');\n\t\t\treturn false;\n\t\t}\n\n\t\tconst containerItem = game.items.get(data.containerItemId);\n\t\tconst containerItemFlags: ItemFlags = <ItemFlags>duplicate(containerItem.getFlag('pick-up-stix', 'pick-up-stix'));\n\t\tconst containerData = containerItemFlags?.container;\n\n\t\tlet loot: ContainerLoot = containerData?.loot;\n\n\t\t// if the container never had any loot, then 'loot' will not exist, so\n\t\t// create an empty object\n\t\tif (!loot) {\n\t\t\tcontainerData.loot = {};\n\t\t\tloot = containerData.loot;\n\t\t}\n\n\t\t// if the 'loot' object doesn't have any loot of the type being\n\t\t// dropped it'll be undefined, so create an empty array, to hold\n\t\t// loot of that item type\n\t\tif (!loot[itemType]) {\n\t\t\tlog(`pick-up-stix | addItemToContainer | No items of type '${itemType}', creating new slot`);\n\t\t\tloot[itemType] = [];\n\t\t}\n\n\t\tconst qtyDataPath = getQuantityDataPath();\n\n\t\tconst existingItem = loot[itemType]\n\t\t\t?.find(i =>\n\t\t\t\ti.name?.toLowerCase() === itemData.name?.toLowerCase()\n\t\t\t\t&& i.img === itemData.img\n\t\t\t\t&& i.data?.description?.value?.toLowerCase() === itemData.data?.description?.value?.toLowerCase()\n\t\t\t\t&& getProperty(i.data, getPriceDataPath()) === getProperty(itemData.data, getPriceDataPath())\n\t\t\t\t&& getProperty(i.data, getWeightDataPath()) === getProperty(itemData.data, getWeightDataPath())\n\t\t\t);\n\n\t\tif (existingItem) {\n\t\t\tlog(`pick-up-stix | addItemToContainer | existing data for type '${itemType}', increase quantity by 1`);\n\t\t\tsetProperty(existingItem.data, qtyDataPath, +getProperty(existingItem.data, qtyDataPath) + 1)\n\t\t}\n\t\telse {\n\t\t\tlog(`pick-up-stix | addItemToContainer | existing data for item '${itemData._id}' does not exist, set quantity to 1 and add to slot`);\n\t\t\tsetProperty(itemData.data, qtyDataPath, 1);\n\t\t\tloot[itemType].push({\n\t\t\t\t...itemData\n\t\t\t});\n\t\t}\n\n\t\tawait updateItem(data.containerItemId, {\n\t\t\tflags: {\n\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\tcontainer: {\n\t\t\t\t\t\t\tloot\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tconst msg: SocketMessage = {\n\t\t\tsender: game.user.id,\n\t\t\ttype: SocketMessageType.itemAddedToContainer,\n\t\t\tdata\n\t\t}\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t\tHooks.callAll(PickUpStixHooks.itemAddedToContainer, data);\n\t\treturn true;\n\t}\n\n\treturn new Promise(resolve => {\n\t\tconst timeout = setTimeout(() => {\n\t\t\tresolve(false);\n\t\t}, gmActionTimeout());\n\n\t\tconst msg: SocketMessage = {\n\t\t\tsender: game.user.id,\n\t\t\ttype: SocketMessageType.addItemToContainer,\n\t\t\tdata\n\t\t};\n\n\t\tlog(`pick-up-stix | addItemToContainer | User is not GM, sending socket msg:`);\n\t\tlog([msg]);\n\n\t\tHooks.once(PickUpStixHooks.itemAddedToContainer, () => {\n\t\t\tlog(`pick-up-stix | addItemToContainer | pick-up-stix.itemAddedToContainer hook | User is not GM, sending socket msg:`);\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve(true);\n\t\t});\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t});\n}\n\nexport const  lootCurrency = async (data: { looterTokenId: string, currencies: any; containerItemId: string }): Promise<boolean> => {\n\tlog(`pick-up-stix | lootCurrency:`);\n\tconsole.log([data]);\n\n\tif (game.user.isGM) {\n\t\tlog(`pick-up-stix | lootCurrency | User is GM, looting currency`);\n\n\t\tconst looterToken = getCanvas().tokens.placeables.find(p => p.id === data.looterTokenId);\n\t\tconst containerItem = game.items.get(data.containerItemId);\n\t\tconst containerFlags: ItemFlags = <ItemFlags>duplicate(containerItem.getFlag('pick-up-stix', 'pick-up-stix'));\n\t\tconst containerCurrencies = containerFlags?.container?.currency;\n\t\tconst currencyToLoot = data.currencies;\n\n\t\t// get the actor's current currencies\n\t\tconst actorCurrency = {\n\t\t\t...getProperty(looterToken.actor.data, getActorCurrencyPath()) ?? {}\n\t\t};\n\n\t\tObject.keys(actorCurrency).forEach(k => actorCurrency[k] = +(actorCurrency[k] ?? 0) + +currencyToLoot[k]);\n\t\tObject.keys(containerCurrencies).forEach(k => containerCurrencies[k] = +containerCurrencies[k] - +currencyToLoot[k]);\n\n\t\tawait updateActor(looterToken.actor, {\n\t\t\t[getActorCurrencyPath()]: actorCurrency\n\t\t});\n\n\t\tawait updateItem(data.containerItemId, {\n\t\t\tflags: {\n\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\tcontainer: {\n\t\t\t\t\t\t\tcurrency: {\n\t\t\t\t\t\t\t\t...containerCurrencies\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tcurrencyCollected(\n\t\t\tlooterToken,\n\t\t\tObject.entries(currencyToLoot)\n\t\t\t\t.filter(([, v]) => v > 0)\n\t\t\t\t.reduce((prev, [k, v]) => { prev[k] = v; return prev; }, {})\n\t\t);\n\n\t\tHooks.callAll(PickUpStixHooks.currencyLooted);\n\n\t\tconst msg: SocketMessage = {\n\t\t\ttype: SocketMessageType.currencyLooted,\n\t\t\tsender: game.user.id,\n\t\t\tdata\n\t\t}\n\n\t\tgame.socket.emit('module.pick-up-stix', msg)\n\t\treturn true;\n\t}\n\n\treturn new Promise(resolve => {\n\t\tconst timeout = setTimeout(() => {\n\t\t\tresolve(false);\n\t\t}, gmActionTimeout());\n\n\t\tconst msg: SocketMessage = {\n\t\t\tsender: game.user.id,\n\t\t\ttype: SocketMessageType.lootCurrency,\n\t\t\tdata\n\t\t}\n\n\t\tHooks.once(PickUpStixHooks.currencyLooted, () => {\n\t\t\tlog(`pick-up-stix | lootCurrency | pick-up-stix.currencyLooted hook`);\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve(true);\n\t\t});\n\n\t\tlog(`pick-up-stix | lootCurrency | User is not GM, sending socket msg:`);\n\t\tlog([msg]);\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t});\n}\n\ninterface LootItemFunction {\n\t/**\n\t * A\n\t */\n\t(data: { looterTokenId: string, itemData: ItemData | ItemData[], lootTokenTokenId: string, takeAll: boolean }): Promise<boolean>;\n\t/**\n\t * B\n\t */\n\t(data: { looterTokenId: string, itemData: ItemData | ItemData[], containerItemId: string, lootTokenTokenId: string, takeAll: boolean }): Promise<boolean>;\n}\n\nexport const lootItem: LootItemFunction = async (data: any): Promise<boolean> => {\n\tlog(`pick-up-stix | lootItem:`);\n\tlog([data]);\n\n\tif (game.user.isGM) {\n\t\tconsole.log(`pick-up-stix | lootItem | User is GM`);\n\n\t\tconst qtyLootedById = {};\n\t\tconst looterToken = getCanvas().tokens.placeables.find(p => p.id === data.looterTokenId);\n\t\tconst looterActorId = looterToken.actor.id;\n\t\tconst itemDatas: ItemData[] = Array.isArray(data.itemData) ? data.itemData : [data.itemData];\n\t\tconst newItemDatas: ItemData[] = itemDatas.reduce((acc, itemData) => {\n\t\t\tconst qty = getProperty(itemData.data, getQuantityDataPath());\n\t\t\tconst datas = [];\n\t\t\tconst actualQty = data.takeAll ? qty : 1;\n      qtyLootedById[itemData._id] = actualQty;\n\n\t\t\tfor (let i = 0; i < actualQty; i++) {\n\t\t\t\tdatas.push(mergeObject(itemData, { data: { [getQuantityDataPath()]: 1 } } as ItemData ));\n\t\t\t}\n\t\t\treturn acc.concat(datas);\n\t\t}, []);\n\n    log(`pick-up-stix | lootItem | Items being looted:`);\n    console.log([newItemDatas]);\n\n\t\tawait createOwnedItem(\n\t\t\tlooterActorId,\n\t\t\tnewItemDatas\n\t\t);\n\n\t\tif (data.containerItemId) {\n\t\t\tconst containerItem = game.items.get(data.containerItemId);\n\t\t\tconst containerItemFlags: ItemFlags = <ItemFlags>duplicate(containerItem?.getFlag('pick-up-stix', 'pick-up-stix') ?? {});\n\t\t\tconst sourceLoot: ContainerLoot = containerItemFlags?.container?.loot;\n\n\t\t\tfor (let [itemType, itemsOfType] of Object.entries(sourceLoot)) {\n\t\t\t\tfor (let itemData of itemsOfType) {\n\t\t\t\t\tif (qtyLootedById[itemData._id] === undefined) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst oldQty = getProperty(itemData?.data, getQuantityDataPath());\n          const newQty = oldQty - qtyLootedById[itemData._id];\n\n\t\t\t\t\tif (newQty <= 0) {\n\t\t\t\t\t\tlog(`pick-up-stix | lootItem | Quantity is now 0, removing item from loot`);\n\t\t\t\t\t\tsourceLoot?.[itemType]?.findSplice(v => v._id === itemData._id);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n            log(`pick-up-stix | lootItem | Subtracting one from quantity`);\n            mergeObject(\n              itemData.data,\n              {\n                [getQuantityDataPath()]: newQty\n              }\n            );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tawait containerItem.update({\n\t\t\t\tflags: {\n\t\t\t\t\t'pick-up-stix': {\n\t\t\t\t\t\t'pick-up-stix': containerItemFlags\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}, {});\n\t\t}\n\t\telse if (data.lootTokenTokenId) {\n\t\t\tconst lootTokenToken: Token = getCanvas().tokens.placeables.find(p => p.id === data.lootTokenTokenId);\n\t\t\tawait deleteToken(lootTokenToken.id, lootTokenToken.scene.id);\n\t\t}\n\n\t\tconst msg: SocketMessage = {\n\t\t\tsender: game.user.id,\n\t\t\ttype: SocketMessageType.itemCollected,\n\t\t\tdata: {\n\t\t\t\ttokenId: data.looterTokenId,\n\t\t\t\tactorId: looterToken.actor.id,\n\t\t\t\tsourceItemId: data.containerItemId,\n\t\t\t\titemData: data.itemData\n\t\t\t}\n\t\t};\n\n    for (const [id, qty] of Object.entries(qtyLootedById)) {\n      createItemCollectedChatMessage(\n        looterToken,\n        mergeObject({\n          ...newItemDatas.find(d => d._id === id)\n        },\n        {\n          data: {\n            [getQuantityDataPath()]: qty\n          }\n        })\n      );\n    }\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t\tHooks.callAll(PickUpStixHooks.itemCollected, data);\n\t\treturn true;\n\t}\n\n\treturn new Promise(resolve => {\n\t\tconst timeout = setTimeout(() => {\n\t\t\tresolve(null);\n\t\t}, gmActionTimeout());\n\n\t\tconst msg: SocketMessage = {\n\t\t\tsender: game.user.id,\n\t\t\ttype: SocketMessageType.collectItem,\n\t\t\tdata\n\t\t}\n\n\t\tHooks.once(PickUpStixHooks.itemCollected, () => {\n\t\t\tconsole.log(`pick-up-stix | lootItem | pick-up-stix.itemCollected hook`);\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve(true);\n\t\t});\n\n\t\tconsole.log(`pick-up-stix | lootItem | User is not GM send msg:`);\n\t\tconsole.log([msg]);\n\n\t\tgame.socket.emit('module.pick-up-stix', msg);\n\t});\n}\n\nexport const currencyCollected = async (token, currency) => {\n\tlog(`pick-up-stix | currencyCollected | called with args:`);\n\tlog([token, currency]);\n\tlet chatContent = '';\n\tObject.entries(currency).forEach(([k, v]) => {\n\t\tchatContent += `<span class=\"pick-up-stix-chat-currency ${k}\"></span><span>(${k}) ${v}</span><br />`;\n\t});\n\tlet content = `<p>Picked up:</p>${chatContent}`;\n\tawait ChatMessage.create({\n\t\tcontent,\n\t\tspeaker: {\n\t\t\talias: token.actor.name,\n\t\t\tscene: token.scene.id,\n\t\t\tactor: token.actor.id,\n\t\t\ttoken: token.id\n\t\t}\n\t});\n}\n\nexport const createItemCollectedChatMessage = async (token, item) => {\n\tawait ChatMessage.create({\n\t\tcontent: `\n\t\t\t<p>Picked up ${item.name} (x${getProperty(item.data, getQuantityDataPath())})</p>\n\t\t\t<img src=\"${item.img}\" style=\"width: 40px;\" />\n\t\t`,\n\t\tspeaker: {\n\t\t\talias: token.actor.name,\n\t\t\tscene: token.scene.id,\n\t\t\tactor: token.actor.id,\n\t\t\ttoken: token.id\n\t\t}\n\t});\n}\n"]}