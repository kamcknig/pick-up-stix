{"version":3,"sources":["module/pick-up-stix/hooks.ts"],"names":[],"mappings":"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","file":"../../../src/module/pick-up-stix/hooks.js","sourcesContent":["/* ------------------------------------ */\r\n/* When ready\t\t\t\t\t\t\t\t\t\t\t\t\t  */\r\n\r\nimport {\r\n\tdisplayItemContainerApplication,\r\n\tsetupMouseManager,\r\n\thandleDropItem,\r\n\tdrawLockIcon,\r\n\tlootTokens\r\n} from \"./main\";\r\nimport { registerSettings } from \"../settings\";\r\nimport { preloadTemplates } from \"../preloadTemplates\";\r\nimport { PickUpStixSocketMessage, SocketMessageType, PickUpStixFlags } from \"./models\";\r\nimport { handleOnDrop } from \"./overrides\";\r\n\r\n/**\r\n * TODO: This should be removed once 0.7.0 becomes stable\r\n */\r\ndeclare class DragDrop {\r\n\tconstructor(options: DragDropOptions);\r\n\r\n\tbind(canvas: any);\r\n}\r\n\r\n/**\r\n * TODO: This should be removed once 0.7.0 becomes stable\r\n */\r\ndeclare interface DragDropOptions {\r\n\tdragSelector?;\r\n\tdropSelector?;\r\n\tpermissions?;\r\n\tcallbacks?;\r\n}\r\n\r\n/* ------------------------------------ */\r\n/* Initialize module\t\t\t\t\t*/\r\n/* ------------------------------------ */\r\nexport async function initHook() {\r\n\tconsole.log('pick-up-stix | initHook');\r\n\r\n\tCONFIG.debug.hooks = true;\r\n\r\n\t// Assign custom classes and constants here\r\n\r\n\t// Register custom module settings\r\n\tregisterSettings();\r\n\r\n\t// Preload Handlebars templates\r\n\tawait preloadTemplates();\r\n\r\n\t// Register custom sheets (if any)\r\n};\r\n\r\n/* ------------------------------------ */\r\nexport function readyHook() {\r\n\t// Do anything once the module is ready\r\n\tconsole.log(`pick-up-stix | readyHook`);\r\n\r\n\tsocket = game.socket;\r\n\r\n\tsocket.on('module.pick-up-stix', async (msg: PickUpStixSocketMessage) => {\r\n\t\tconsole.log(`pick-up-stix | socket.on | received socket message with args:`);\r\n\t\tconsole.log(msg);\r\n\r\n\t\tif (msg.sender === game.user.id) {\r\n\t\t\tconsole.log(`pick-up-stix | socket.on | i sent this, ignoring`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst firstGm = game.users.find((u) => u.isGM && u.active);\r\n\t\tif (firstGm && game.user !== firstGm) {\r\n   \t\treturn;\r\n\t\t}\r\n\r\n\t\tlet actor;\r\n\t\tlet token;\r\n\r\n\t\tswitch (msg.type) {\r\n\t\t\tcase SocketMessageType.updateActor:\r\n\t\t\t\tactor = game.actors.get(msg.data.actorId);\r\n\t\t\t\tawait actor.update(msg.data.updates);\r\n\t\t\t\tbreak;\r\n\t\t\tcase SocketMessageType.deleteToken:\r\n\t\t\t\tawait canvas.scene.deleteEmbeddedEntity('Token', msg.data);\r\n\t\t\t\tbreak;\r\n\t\t\tcase SocketMessageType.updateToken:\r\n\t\t\t\ttoken = canvas.tokens.get(msg.data.tokenId);\r\n\t\t\t\tawait token.update(msg.data.updates);\r\n\t\t\t\tbreak;\r\n\t\t\tcase SocketMessageType.createOwnedEntity:\r\n\t\t\t\tactor = game.actors.get(msg.data.actorId);\r\n\t\t\t\tawait actor.createOwnedItem(msg.data.items);\r\n\t\t\t\tbreak;\r\n\t\t\tcase SocketMessageType.createItemToken:\r\n\t\t\t\tawait Token.create(msg.data);\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t});\r\n};\r\n\r\nexport async function onCanvasReady(...args) {\r\n\tconsole.log(`pick-up-stix | onCanvasReady | call width args:`);\r\n\tconsole.log(args);\r\n\r\n  canvas?.tokens?.placeables?.forEach(async (p: PlaceableObject) => {\r\n\t\tconst flags: PickUpStixFlags = p.getFlag('pick-up-stix', 'pick-up-stix');\r\n\r\n\t\tif (flags) {\r\n\t\t\tconsole.log(`pick-up-stix | onCanvasReady | found token ${p.id} with itemData`);\r\n\t\t\tp.mouseInteractionManager = setupMouseManager.bind(p)();\r\n\r\n\t\t\tif (flags.isLocked) {\r\n\t\t\t\tawait drawLockIcon(p);\r\n\t\t\t}\r\n\t\t}\r\n  });\r\n\r\n\tconst coreVersion: string = game.data.version;\r\n\tif (isNewerVersion(coreVersion, '0.6.5')) {\r\n    console.log(`pick-up-stix | onCanvasReady | Foundry version newer than 0.6.5. Using dropCanvasData hook`);\r\n\r\n\t\tHooks.on('dropCanvasData', async (canvas, dropData) => {\r\n\t\t\tconsole.log(`pick-up-stix | dropCanvasData | called with args:`);\r\n\t\t\tconsole.log(canvas, dropData);\r\n\r\n\t\t\tif (dropData.type === \"Item\") {\r\n\t\t\t\thandleDropItem(dropData);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse {\r\n\t\tconsole.log(`pick-up-stix | onCanvasReady | Foundry version is 0.6.5 or below. Overriding Canvas._onDrop`);\r\n\t\tcanvas._dragDrop = new DragDrop({ callbacks: { drop: handleOnDrop.bind(canvas) } }).bind(document.getElementById('board'));\r\n\t}\r\n}\r\n\r\nexport async function onRenderTokenHud(hud: TokenHUD, hudHtml: JQuery, data: any) {\r\n  if (!data.isGM) {\r\n\t\tconsole.log(`pick-up-stix | onRenderTokenHud | user is not a gm, don't change HUD`);\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (data.actorId && !game.actors.get(data.actorId).isPC && !game.modules.get('lootsheetnpc5e').active) {\r\n\t\tconsole.log(`pick-up-stix | onRenderTokenHud | token has an actor associated with it, dont' change HUD`);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconsole.log(`pick-up-stix | onRenderTokenHud | called with args:`);\r\n\tconsole.log(hud, hudHtml, data);\r\n\r\n\tconst flags = getProperty(data.flags, 'pick-up-stix.pick-up-stix');\r\n\r\n\tconst containerDiv = document.createElement('div');\r\n\tcontainerDiv.style.display = 'flex';\r\n\tcontainerDiv.style.flexDirection = 'row';\r\n\r\n\t// create the control icon div and add it to the container div\r\n\tconst controlIconDiv = document.createElement('div');\r\n\tcontrolIconDiv.className = 'control-icon';\r\n\tconst controlIconImg = document.createElement('img');\r\n\tcontrolIconImg.src = flags?.['itemData']?.some(data => data.count > 0) || Object.values(flags?.currency ?? {}).some(amount => amount > 0)\r\n\t\t? 'modules/pick-up-stix/assets/pick-up-stix-icon-white.svg'\r\n\t\t: 'modules/pick-up-stix/assets/pick-up-stix-icon-black.svg';\r\n\tcontrolIconImg.className = \"item-pick-up\";\r\n\tcontrolIconDiv.appendChild(controlIconImg);\r\n\tcontrolIconDiv.addEventListener('mousedown', displayItemContainerApplication(hud, controlIconImg, data));\r\n\tcontainerDiv.appendChild(controlIconDiv);\r\n\r\n\t// if the item is a container then add the lock icon\r\n\tif (flags?.isContainer) {\r\n\t\tconst lockDiv = document.createElement('div');\r\n\t\tlockDiv.style.marginRight = '10px';\r\n\t\tlockDiv.className = 'control-icon';\r\n\t\tconst lockImg = document.createElement('img');\r\n\t\tlockImg.src = flags?.['isLocked']\r\n\t\t\t? 'modules/pick-up-stix/assets/lock-white.svg'\r\n\t\t\t: 'modules/pick-up-stix/assets/lock-black.svg';\r\n\t\tlockDiv.appendChild(lockImg);\r\n\t\t/* lockDiv.addEventListener('mousedown', toggleLocked(hud, data)); */\r\n\t\tcontainerDiv.prepend(lockDiv);\r\n\t}\r\n\r\n\t// add the container to the hud\r\n\t$(hudHtml.children('div')[0]).prepend(containerDiv);\r\n};\r\n\r\nexport async function onPreCreateOwnedItem(actor: Actor, itemData: any, options: any, userId: string) {\r\n\tconsole.log(`pick-up-stix | onPreCreateOwnedItem | called with args:`);\r\n\tconsole.log([actor, itemData, options, userId]);\r\n\r\n\tlet owner: { actorId: string, itemId: string };\r\n\tif (owner = getProperty(itemData.flags, 'pick-up-stix.pick-up-stix.owner')) {\r\n\t\t// if the item is already owned by someone else, set the new actor as the owner and\r\n\t\t// delete the item from the old owner\r\n\t\tsetProperty(itemData.flags, 'pick-up-stix.pick-up-stix.owner', { actorId: actor.id });\r\n\t\tconst ownerActor = game.actors.get(owner.actorId);\r\n\t\tawait ownerActor.deleteOwnedItem(itemData._id);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsetProperty(itemData.flags, 'pick-up-stix.pick-up-stix.owner', { actorId: actor.id });\r\n};\r\n\r\nexport async function onPreUpdateToken(scene: Scene, tokenData: any, data: any, userId: string) {\r\n\ttry {\r\n\t\tconst currentLocked: boolean = getProperty(tokenData.flags, 'pick-up-stix.pick-up-stix.isLocked');\r\n\t\tconst newLocked: boolean = getProperty(data.flags, 'pick-up-stix.pick-up-stix.isLocked');\r\n\r\n\t\t// if we are currently locked and this update unlocks the item, then set a temp flag to delete the lock after the update\r\n\t\tif (currentLocked && !newLocked) {\r\n\t\t\tsetProperty(data.flags, 'pick-up-stix.pick-up-stix.deleteLock', true);\r\n\t\t}\r\n\t}\r\n\tcatch (e) {\r\n\r\n\t}\r\n}\r\n\r\nexport function onDeleteToken(scene: Scene, tokenData: any, data: any, userId: string) {\r\n\tconsole.log(`pick-up-stix | onDeleteToken | called with args:`);\r\n\tconsole.log([scene, tokenData, data, userId]);\r\n\tlootTokens.findSplice(t => t === tokenData._id);\r\n}\r\n\r\nexport async function onUpdateToken(scene: Scene, tokenData: any, tokenFlags: any, userId: string) {\r\n  console.log(`pick-up-stix | onUpdateToken | called with args:`)\r\n  console.log([scene, tokenData, tokenFlags, userId]);\r\n\r\n  const flags = getProperty(tokenData, 'flags.pick-up-stix.pick-up-stix');\r\n\r\n\tif (flags) {\r\n      console.log(`pick-up-stix | onUpdateToken | found flags on token data, add mouse interaction`);\r\n\t\t\tconst token: Token = canvas?.tokens?.placeables?.find((p: PlaceableObject) => p.id === tokenData._id);\r\n\r\n\t\t\tif (flags.isLocked) {\r\n\t\t\t\tawait drawLockIcon(token);\r\n\t\t\t}\r\n\t\t\telse if (flags.deleteLock) {\r\n\t\t\t\ttoken.removeChildAt(token.children.length - 1).destroy();\r\n\t\t\t\tawait token.unsetFlag('pick-up-stix', 'pick-up-stix.deleteLock');\r\n\t\t\t}\r\n\r\n\t\t\ttoken.mouseInteractionManager = setupMouseManager.bind(token)();\r\n\t\t\ttoken.activateListeners = setupMouseManager.bind(token);\r\n\t}\r\n};\r\n\r\nexport async function onCreateToken(scene: Scene, tokenData: any, options: any, userId: string) {\r\n  console.log(`pick-up-stix | onCreateToken | called with args:`);\r\n  console.log([scene, tokenData, options, userId]);\r\n\r\n  const flags = getProperty(tokenData, 'flags.pick-up-stix.pick-up-stix');\r\n\r\n\tif (flags) {\r\n      console.log(`pick-up-stix | onCreateToken | found flags on token data, add mouse interaction`);\r\n      const token: Token = canvas?.tokens?.placeables?.find((p: PlaceableObject) => p.id === tokenData._id);\r\n\t\t\ttoken.mouseInteractionManager = setupMouseManager.bind(token)();\r\n\t\t\ttoken.activateListeners = setupMouseManager.bind(token);\r\n\t}\r\n};\r\n"]}